define(["require","app","jquery","./addForm","../common/editPop","../data/getData","../moduls/Tool","search","./mysearchForm","formlist","fixedNav","position","../moduls/service","../moduls/factory"],function(e,t,a,n,l,c,i,s,d){t.directive("mynewsList",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"../template/common/list.html",controller:function(t,s,o,m,r){function u(e){var n=[{name:"文章ID",key:"id",width:"50"},{name:"所属栏目",key:"channelAndColumnName",width:"70"},{name:"标题",key:"title"},{name:"作者",key:"author",width:"40",class:"center"},{name:"发布人",key:"buildUserName",width:"55",class:"center"},{name:"修改人",key:"lastModifyUserName",width:"55",class:"center"},{name:"媒体来源",key:"source",width:"80",class:"center"},{name:"发布时间",key:"buildTimeStr",width:"80",class:"center"},{name:"修改时间",key:"updateTimeStr",width:"80",class:"center"},{name:"状态",key:"publishStr",width:"40",class:"center"},{name:"操作",width:"50",class:"center"},{name:"预览",width:"50",class:"center"},{name:"权限",width:"50",class:"center"}];e.data.list&&a.each(e.data.list,function(e,t){t.channelAndColumnName=[t.channelName,t.columnName].join("-")}),t.listdata={title:t.title,table:{select:!0,th:n,td:r.setArr(e.data.list,n),edit:[{cls:"",name:"编辑",evt:t.edit},{cls:"",name:" 推荐",evt:t.recommend}],edit1:[{cls:"zoom_in",name:"预览",href:"/webapi/news/preview/"}],permission:[{cls:"del",name:" 撤销",evt:t.rescind},{cls:"del",name:"删除",evt:t.del}]}},a.each(t.listdata.table.td,function(e,t){t.publish&&(t.list[2].href=t.url)}),r.extendType(t.listdata.table.td,n,["width","name","key"]),r.extendChild(t.listdata.table.td,t.listdata.table.edit,"edit"),r.extendChild(t.listdata.table.td,t.listdata.table.edit1,"edit1"),r.extendChild(t.listdata.table.td,t.listdata.table.permission,"permission"),t.$apply()}function h(){c.news.mynewslist({page:f,pageSize:20,callback:function(e){t.page=e.data.page,t.page.jump=function(e){f!=e.curr&&(f=e.curr,h())},u(e)}})}t.title="我的新闻列表",t.$parent.menu.push({name:t.title}),angular.extend(t,{edit:function(e){function s(n,l){c.news.newsdetail({id:e.id,callback:function(e){function s(t){if("selectSize"==t.type&&e.data.columnIds&&e.data.columnIds.length){t.toSelect=i.changeObjectName(e.data.columnIds,[{name:"val",newName:"id"},{name:"title",newName:"name"}]);var n=t.toSelect.slice(0),l=!0,c=[];n.length&&(a.each(t.fromSelect,function(e,t){l=!0;for(var a=0;a<n.length;a++)if(n[a].id==t.id){l=!1;break}1==l&&c.push(t)}),t.fromSelect=c)}}if(e.data.timer?e.data.writeTime=new Date(e.data.timer).format("yyyy-MM-dd h:m:s"):e.data.writeTime="",e.data.editPublishTime&&(e.data.editPublishTime=new Date(e.data.editPublishTime).format("yyyy-MM-dd h:m:s")),e.data.timer&&(e.data.timer=new Date(e.data.timer).format("yyyy-MM-dd h:m:s")),l){var d,o,m,r,u,h,f,b=2;for(a.each(l,function(n,b){"field1"==b.title?(o=b.title.replace(b.title.match(/\d+$/)[0],""),m=b.name,r=b.inputMaxNum,u=b.type,h=l.slice(0,n+1),f=l.slice(n+1),d=b.inputMaxNum+1):"select"==b.type&&(c.channel.currentChannelList({categoryId:e.data.categoryId,callback:function(e){var a=[b.select[1][0]];b.select[1]=a,b.select[1]=b.select[1].concat(i.changeObjectName(e.data,[{name:"channelName",newName:"name"}])),t.$apply()}}),c.news.newscolumnlist({channelId:e.data.channelId,callback:function(e){var a=[b.select[2][0]];b.select[2]=a,b.select[2]=b.select[2].concat(i.changeObjectName(e.data,[{name:"columnName",newName:"name"}])),t.$apply()}})),"array"==a.type(b)?a.each(b,function(e,t){s(t)}):s(b)});b<d;b++)e.data["field"+b]&&h.push({title:o+b,name:m+b,placeholder:"请输入扩展字段内容",num:b,inputMaxNum:r,type:u});n(h.concat(f))}else n(e)}})}e.size="news",l.init({obj:e,list:n,updateData:s,save:function(e,t){var n=t.channelId,l=t.columnId,s=t.categoryId,d="[";e.selectSizeChoose?(e.selectSizeChoose=i.changeObjectName(e.selectSizeChoose,[{name:"id",newName:"val"},{name:"name",newName:"title"}]),a.each(e.selectSizeChoose,function(e,t){d+='{"title":"'+t.title+'","val":"'+t.val+'"},'}),d=d.substr(0,d.length-1),d+="]"):t.columnIds?(a.each(t.columnIds,function(e,t){d+='{"title":"'+t.title+'","val":"'+t.val+'"},'}),d=d.substr(0,d.length-1),d+="]"):d=null,a.each(e.selects,function(){"channelId"==this.title&&(n=this.id),"columnId"==this.title&&(l=this.id),"categoryId"==this.title&&(s=this.id)}),c.news.updateNews({id:t.id,title:e.title,subTitle:e.subTitle,keyword:e.keyword,description:e.description,source:e.source,author:e.author,channelId:n,columnIds:d,columnId:l,categoryId:s,content:e.html,autoPublish:"yes"==e.show?1:0,timer:e.timer,editPublishTime:e.editPublishTime,field1:e.field1,field2:e.field2,field3:e.field3,field4:e.field4,field5:e.field5,callback:function(e){layui.use(["layer"],function(){layui.layer.msg(e.message)})}})},callback:function(e,n){a.each(e,function(e,a){"content"==a.title&&(a.width="1000px"),"select"==a.type&&(a.callback=function(e){"categoryId"==e.title?c.channel.currentChannelList({categoryId:e.obj.id,callback:function(n){var l=[a.select[1][0]];a.select[1]=l,a.select[1]=a.select[1].concat(i.changeObjectName(n.data,[{name:"channelName",newName:"name"}])),t.$apply(),e.callback()}}):"channelId"==e.title&&c.news.newscolumnlist({channelId:e.obj.id,callback:function(n){var l=[a.select[2][0]];a.select[2]=l,a.select[2]=a.select[2].concat(i.changeObjectName(n.data,[{name:"columnName",newName:"name"}])),t.$apply(),e.callback()}})})}),s(function(e){n(e)},e)},$uibModal:o})},rescind:function(e){e.callback=function(n){layui.use(["layer"],function(){layui.layer.msg(n.message),0==n.code&&(a("table").find("tr[data-id="+e.id+"]").hide(),t.getNewList())})},s.alert({text:'您确定要撤销"'+e.title+'"吗',btn:["确定","取消"],fn:function(){c.news.rescind(e)}})},recommend:function(t){var n=t.id;e(["./recommendForm"],function(e){l.init({obj:t,$uibModal:o,list:e,updateData:function(e){c.news.recommendNewsInfo({id:t.id,callback:function(t){e(t)}})},save:function(e,t){var l=t.recommendColumnId;a.each(e.selects,function(){"recommendColumnId"==this.title&&(l=this.id)}),void 0!=l?c.news.recommend({id:n,recommendTitle:e.recommendTitle,recommendDescription:e.recommendDescription,recommendImages:e.recommendImages,recommendColumnId:l,sort:e.sort,callback:function(e){layui.use(["layer"],function(){layui.layer.msg(e.message)})}}):alert("请选择推荐栏目")},callback:function(e,t){t(e)}})})},info:function(e){s.alert({text:"去相关页面，因为还没有页面所以这样提示：<br>ID为："+e.id,btn:["确定","取消"]})},del:function(e){e.callback=function(t){layui.use(["layer"],function(){layui.layer.msg(t.message),0==t.code&&a("table").find("tr[data-id="+e.id+"]").hide()})},s.alert({text:'您确定要删除"'+e.title+'"吗',btn:["确定","取消"],fn:function(){c.news.delNews(e)}})},publish:function(e){e.callback=function(e){layui.use(["layer"],function(){layui.layer.msg(e.message)})},s.alert({text:'您确定要发布"'+e.title+'"吗',btn:["确定","取消"],fn:function(){c.news.publish(e)}})}}),d(function(e){a.each(e,function(e,a){"select"==a.type&&(a.callback=function(e){"categoryId"==e.title?c.channel.currentChannelList({categoryId:e.obj.id,callback:function(n){var l=[a.select[1][0]];a.select[1]=l,a.select[1]=a.select[1].concat(i.changeObjectName(n.data,[{name:"channelName",newName:"name"}])),t.$apply(),e.callback()}}):"channelId"==e.title&&c.news.newscolumnlist({channelId:e.obj.id,callback:function(n){var l=[a.select[2][0]];a.select[2]=l,a.select[2]=a.select[2].concat(i.changeObjectName(n.data,[{name:"columnName",newName:"name"}])),t.$apply(),e.callback()}})})}),t.searchform={list:e,return:function(){t.searchform.search=null,f=1,t.$$childHead.current=1,h()},submit:function(e,a){function n(){c.news.mynewslist({publish:l,page:f,pageSize:20,callback:function(a){t.page=a.data.page,t.page.jump=function(e){f!=e.curr&&(f=e.curr,n())},t.searchform.search={count:a.data.page.count,name:e.condition},void 0==a.data.list&&(a.data.list=[]),u(a)}})}var l;"已发布"==e.publish?l=1:"未发布"==e.publish?l=0:"草稿"==e.publish?l=2:"已撤销"==e.publish&&(l=3),n(),t.getSearchList=n}}});var f=1;h()},link:function(e,t){}}})});