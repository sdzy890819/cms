define(["require","app","jquery","search","./searchForm","./addForm","../common/editPop","../data/getData","../moduls/Tool","formlist","fixedNav","position","../moduls/service","../moduls/factory"],function(e,t,a,n,c,i,l,s,o){t.directive("newsManage",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"../template/common/list.html",controller:function(t,n,d,r,u,m){function h(e){var n=[{name:"文章ID",key:"id",width:"50"},{name:"所属频道栏目",key:"channelAndColumnName",width:"70"},{name:"标题",key:"title"},{name:"作者",key:"author",width:"40",class:"center"},{name:"发布人",key:"buildUserName",width:"40",class:"center"},{name:"修改人",key:"lastModifyUserName",width:"40",class:"center"},{name:"媒体来源",key:"source",width:"40",class:"center"},{name:"发布时间",key:"buildTimeStr",width:"80",class:"center"},{name:"修改时间",key:"updateTimeStr",width:"80",class:"center"},{name:"状态",key:"publishStr",width:"40",class:"center"},{name:"操作",width:"50",class:"center"}];a.each(e.data.list,function(e,t){t.channelAndColumnName=[t.channelName,t.columnName].join("-"),o.getByteLen(t.author)>6&&(t.author=o.getByteVal(t.author,6))}),t.listdata={title:t.title+"（共"+e.data.page.count+"条数据）",table:{select:!0,th:n,td:u.setArr(e.data.list,n),edit:[{cls:"",name:"撤销",evt:t.rescind},{cls:"",name:"恢复",evt:t.recover},{cls:"",name:"恢复并发布",evt:t.recoverRelease}]}},a.each(t.listdata.table.td,function(e,t){t.publish&&(t.list[2].href=t.url)}),u.extendType(t.listdata.table.td,n,["width","name","key"]),u.extendChild(t.listdata.table.td,t.listdata.table.edit,"edit"),u.extendChild(t.listdata.table.td,t.listdata.table.permission,"permission"),t.$apply()}function f(){t.isSearch=!1,s.news.newsManageList({page:y,pageSize:20,callback:function(e){t.page=e.data.page,t.page.jump=function(e){y!=e.curr&&(y=e.curr,f())},h(e)}})}t.title="删除新闻列表",t.$parent.menu.push({name:t.title}),angular.extend(t,{isSearch:!1,getNewList:function(){t.isSearch?t.getSearchList():f()},edit:function(e){function n(n,c){s.news.newsdetail({id:e.id,callback:function(e){if(e.data.timer?e.data.writeTime=new Date(e.data.timer).format("yyyy-MM-dd h:m:s"):e.data.writeTime="",e.data.editPublishTime&&(e.data.editPublishTime=new Date(e.data.editPublishTime).format("yyyy-MM-dd h:m:s")),c){var i,l,d,r,u,m,h,f=2;for(a.each(c,function(a,n){"field1"==n.title?(l=n.title.replace(n.title.match(/\d+$/)[0],""),d=n.name.match(/\d+$/),d=d?n.name.replace(d[0],""):n.name,r=n.inputMaxNum,u=n.type,m=c.slice(0,a+1),h=c.slice(a+1),i=n.inputMaxNum+1):"select"==n.type&&(s.channel.currentChannelList({categoryId:e.data.categoryId,callback:function(e){var a=[n.select[1][0]];n.select[1]=a,n.select[1]=n.select[1].concat(o.changeObjectName(e.data,[{name:"channelName",newName:"name"}])),t.$apply()}}),s.news.newscolumnlist({channelId:e.data.channelId,callback:function(e){var a=[n.select[2][0]];n.select[2]=a,n.select[2]=n.select[2].concat(o.changeObjectName(e.data,[{name:"columnName",newName:"name"}])),t.$apply()}}))});f<i;f++)e.data["field"+f]&&m.push({title:l+f,name:d+f,placeholder:"请输入扩展字段内容",num:f,inputMaxNum:r,type:u});n(m.concat(h))}else n(e)}})}l.init({obj:e,list:i,updateData:n,save:function(e,n){var c=n.channelId,i=n.columnId,l=n.categoryId;a.each(e.selects,function(){"channelId"==this.title&&(c=this.id),"columnId"==this.title&&(i=this.id),"categoryId"==this.title&&(l=this.id)});var o=(new Date).valueOf();new Date(e.writeTime).valueOf()<o?alert("发布时间必须大于当前时间"):s.news.updateNews({id:n.id,title:e.title,subTitle:e.subTitle,keyword:e.keyword,description:e.description,source:e.source,author:e.author,channelId:c,columnId:i,categoryId:l,content:e.html,autoPublish:"yes"==e.show?1:0,timer:e.writeTime,field1:e.field1,field2:e.field2,field3:e.field3,field4:e.field4,field5:e.field5,callback:function(e){layui.use(["layer"],function(){layui.layer.msg(e.message),t.getNewList()})}})},callback:function(e,c){a.each(e,function(e,a){"content"==a.title&&(a.width="650px"),"select"==a.type&&(a.callback=function(e){e.obj.name.indexOf("请选择")>-1||("categoryId"==e.title?s.channel.currentChannelList({categoryId:e.obj.id,callback:function(n){var c=[a.select[1][0]];a.select[1]=c,a.select[1]=a.select[1].concat(o.changeObjectName(n.data,[{name:"channelName",newName:"name"}])),a.select[2]=[a.select[2][0]],t.$apply(),e.callback()}}):"channelId"==e.title&&s.news.newscolumnlist({channelId:e.obj.id,callback:function(n){var c=[a.select[2][0]];a.select[2]=c,a.select[2]=a.select[2].concat(o.changeObjectName(n.data,[{name:"columnName",newName:"name"}])),t.$apply(),e.callback()}}))})}),n(function(e){c(e)},e)},$uibModal:d})},recommend:function(n){var c=n.id;e(["./recommendForm"],function(e){l.init({obj:n,$uibModal:d,list:e,updateData:function(e){s.news.recommendNewsInfo({id:n.id,callback:function(t){e(t)}})},save:function(e){var n;a.each(e.selects,function(){"recommendColumnId"==this.title&&(n=this.id)}),void 0!=n?s.news.recommend({id:c,recommendTitle:e.recommendTitle,recommendDescription:e.recommendDescription,recommendImages:e.recommendImages,recommendColumnId:n,sort:e.sort,callback:function(e){layui.use(["layer"],function(){layui.layer.msg(e.message),t.getNewList()})}}):alert("请选择推荐栏目")},callback:function(e,t){t(e)}})})},info:function(e){n.alert({text:"去相关页面，因为还没有页面所以这样提示：<br>ID为："+e.id,btn:["确定","取消"]})},del:function(e){e.callback=function(t){layui.use(["layer"],function(){layui.layer.msg(t.message),0==t.code&&a("table").find("tr[data-id="+e.id+"]").hide()})},n.alert({text:'您确定要删除"'+e.title+'"吗',btn:["确定","取消"],fn:function(){s.news.delNews(e)}})},rescind:function(e){e.callback=function(n){layui.use(["layer"],function(){layui.layer.msg(n.message),0==n.code&&(a("table").find("tr[data-id="+e.id+"]").hide(),t.getNewList())})},n.alert({text:'您确定要撤销"'+e.title+'"吗',btn:["确定","取消"],fn:function(){s.news.rescind(e)}})},recover:function(e){e.callback=function(e){layui.use(["layer"],function(){layui.layer.msg(e.message),0==e.code&&t.getNewList()})},n.alert({text:'您确定要恢复"'+e.title+'"吗',btn:["确定","取消"],fn:function(){s.news.recover(e)}})},recoverRelease:function(e){e.callback=function(e){layui.use(["layer"],function(){layui.layer.msg(e.message),0==e.code&&t.getNewList()})},n.alert({text:'您确定要恢复"'+e.title+'"吗',btn:["确定","取消"],fn:function(){e.publish=1,s.news.recover(e)}})},publish:function(e){e.callback=function(e){layui.use(["layer"],function(){layui.layer.msg(e.message),t.getNewList()})},n.alert({text:'您确定要发布"'+e.title+'"吗',btn:["确定","取消"],fn:function(){s.news.publish(e)}})}}),c(function(e){a.each(e,function(e,a){"select"==a.type&&(a.callback=function(e){"categoryId"==e.title?s.channel.currentChannelList({categoryId:e.obj.id,callback:function(n){var c=[a.select[1][0]];a.select[1]=c,a.select[1]=a.select[1].concat(o.changeObjectName(n.data,[{name:"channelName",newName:"name"}])),t.$apply(),e.callback()}}):"channelId"==e.title&&s.news.newscolumnlist({channelId:e.obj.id,callback:function(n){var c=[a.select[2][0]];a.select[2]=c,a.select[2]=a.select[2].concat(o.changeObjectName(n.data,[{name:"columnName",newName:"name"}])),t.$apply(),e.callback()}})})}),t.searchform={list:e,return:function(){t.searchform.search=null,y=1,searchPage=1,t.$$childHead.current=1,f()},submit:function(e,n){function c(){s.search.searchNew({newsId:e.newsId,buildUserName:e.buildUserName,lastModifyUserName:e.lastModifyUserName,condition:e.condition,author:e.author,source:e.source,categoryId:o,channelId:i,columnId:l,platform:e.platform,startTime:e.startTime,endTime:e.endTime,publish:d,delTag:0,page:r,pageSize:20,callback:function(a){t.page=a.data.page,t.page.jump=function(e){r!=e.curr&&(r=e.curr,c())},t.searchform.search={count:a.data.page.count,name:e.condition},h(a)}})}t.isSearch=!0;var i,l,o,d,r=1;a.each(e.selects,function(){"channelId"==this.title&&(i=this.id),"columnId"==this.title&&(l=this.id),"categoryId"==this.title&&(o=this.id),"publish"==this.title&&(d=this.id)}),c(),t.getSearchList=c}},setTimeout(function(){var e=a('.layui-form input[name="condition"');a("<br>").insertBefore(e.parent().parent())},300)});var y=1;f()},link:function(e,t){}}})});