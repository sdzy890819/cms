define(["app","./addForm","../data/getData","../moduls/Tool","form","position","fixedNav"],function(e,a,l,n){e.directive("newsAdd",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"../template/common/addAndEdit.html",controller:function(e,t){function c(e,a){return e.title.length>255?(layui.use("layer",function(){layui.layer.msg("标题不能超过255个字符!",{icon:2,anim:6})}),!1):e.subTitle.length>255?(layui.use("layer",function(){layui.layer.msg("附标题不能超过255个字符!",{icon:2,anim:6})}),!1):e.keyword.length>255?(layui.use("layer",function(){layui.layer.msg("关键字不能超过255个字符!",{icon:2,anim:6})}),!1):e.author.length>255?(layui.use("layer",function(){layui.layer.msg("来源不能超过255个字符!",{icon:2,anim:6})}),!1):e.stock.search(/[^\d]/)>-1||e.stock.length>6?(layui.use("layer",function(){layui.layer.msg("请输入正确的股票代码!",{icon:2,anim:6})}),!1):e.description.length>500?(layui.use("layer",function(){layui.layer.msg("描述不能超过500个字符!",{icon:2,anim:6})}),!1):e.html.length>65535?(layui.use("layer",function(){layui.layer.msg("内容不能超过65535个字符!",{icon:2,anim:6})}),!1):e.field1.length>255?(layui.use("layer",function(){layui.layer.msg("扩展字段不能小于255位数!",{icon:2,anim:6})}),!1):e.field2&&e.field2.length>255?(layui.use("layer",function(){layui.layer.msg("扩展字段不能小于255位数!",{icon:2,anim:6})}),!1):e.field3&&e.field3.length>255?(layui.use("layer",function(){layui.layer.msg("扩展字段不能小于255位数!",{icon:2,anim:6})}),!1):e.field4&&e.field4.length>255?(layui.use("layer",function(){layui.layer.msg("扩展字段不能小于255位数!",{icon:2,anim:6})}),!1):!(e.field5&&e.field5.length>255)||(layui.use("layer",function(){layui.layer.msg("扩展字段不能小于255位数!",{icon:2,anim:6})}),!1)}function i(a){if(c(a)){a.selectSizeChoose?(a.selectSizeChoose=n.changeObjectName(a.selectSizeChoose,[{name:"id",newName:"val"},{name:"name",newName:"title"}]),$.each(a.selectSizeChoose,function(e,a){r+='{"title":"'+a.title+'","val":"'+a.val+'"},'}),r=r.substr(0,r.length-1),r+="]"):r=null,$.each(a.selects,function(){"channelId"==this.title&&(u=this.id),"columnId"==this.title&&(s=this.id),"categoryId"==this.title&&(o=this.id)});var i=(new Date).valueOf();new Date(a.writeTime).valueOf()<i?alert("发布时间必须大于当前时间"):l.news.createNews({title:a.title,subTitle:a.subTitle,keyword:a.keyword,description:a.description,source:a.source,author:a.author,channelId:u,columnId:s,categoryId:o,content:a.html,autoPublish:"yes"==a.show?1:0,editPublishTime:a.editPublishTime,timer:a.writeTime,field1:a.field1,field2:a.field2,field3:a.field3,field4:a.field4,field5:a.field5,columnIds:r,publish:a.publish,stockCode:a.stock,callback:function(a){layui.use(["layer"],function(){layui.layer.msg(a.message),0==a.code&&(e.clearSelect(),t.reload())})}})}}e.$parent.menu.push({name:"新增新闻"});var o,u,s,r="[";angular.extend(e,{rlease:function(e){e.html.length<10?layui.use("layer",function(){layui.layer.msg("内容不能小于10位数!",{icon:2,anim:6})}):(e.publish=0,i(e))},draft:function(e){e.publish=2,i(e)}}),a(function(a){$.each(a,function(a,t){"content"==t.title&&(t.width="1100px"),"select"==t.type&&(l.news.previousColumn({callback:function(a){o=a.data.categoryId,u=a.data.channelId,s=a.data.columnId,l.channel.currentChannelList({categoryId:o,callback:function(a){var l=[t.select[1][0]];t.select[1]=l,t.select[1]=t.select[1].concat(n.changeObjectName(a.data,[{name:"channelName",newName:"name"}])),e.$apply()}}),l.news.newscolumnlist({channelId:u,callback:function(a){var l=[t.select[2][0]];t.select[2]=l,t.select[2]=t.select[2].concat(n.changeObjectName(a.data,[{name:"columnName",newName:"name"}])),e.$apply()}}),e.data={categoryId:o,channelId:u,columnId:s,source:a.data.source||""},e.$apply()}}),t.callback=function(a){"categoryId"==a.title?l.channel.currentChannelList({categoryId:a.obj.id,callback:function(l){var c=[t.select[1][0]];t.select[1]=c,t.select[1]=t.select[1].concat(n.changeObjectName(l.data,[{name:"channelName",newName:"name"}])),t.select[2]=[t.select[2][0]],e.$apply(),a.callback()}}):"channelId"==a.title&&l.news.newscolumnlist({channelId:a.obj.id,callback:function(l){var c=[t.select[2][0]];t.select[2]=c,t.select[2]=t.select[2].concat(n.changeObjectName(l.data,[{name:"columnName",newName:"name"}])),e.$apply(),a.callback()}})})}),e.formdata={title:"新增新闻",list:a,submit:[{name:"提交",evt:"rlease",icon_cls:"ok"},{name:"保存草稿",evt:"draft",icon_cls:"view"},{name:"取消",evt:"cancel",icon_cls:"cancel",cls:"cancel"}]},e.clearSelect=function(){function a(e){"selectSize"==e.type&&(e.toSelect=[])}$.each(e.formdata.list,function(e,l){"array"==$.type(l)?$.each(l,function(e,l){a(l)}):a(l)})},e.clearSelect(),e.$apply()})}}})});