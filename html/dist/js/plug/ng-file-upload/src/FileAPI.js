/*! FileAPI 2.0.7 - BSD | git://github.com/mailru/FileAPI.git
 * FileAPI — a set of  javascript tools for working with files. Multiupload, drag'n'drop and chunked file upload. Images: crop, resize and auto orientation by EXIF.
 */
/*
 * JavaScript Canvas to Blob 2.0.5
 * https://github.com/blueimp/JavaScript-Canvas-to-Blob
 *
 * Copyright 2012, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 *
 * Based on stackoverflow user Stoive's code snippet:
 * http://stackoverflow.com/q/4998908
 */
!function(window){"use strict";var CanvasPrototype=window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype,hasBlobConstructor=window.Blob&&function(){try{return Boolean(new Blob)}catch(e){return!1}}(),hasArrayBufferViewSupport=hasBlobConstructor&&window.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return!1}}(),BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,dataURLtoBlob=(hasBlobConstructor||BlobBuilder)&&window.atob&&window.ArrayBuffer&&window.Uint8Array&&function(dataURI){var byteString,arrayBuffer,intArray,i,mimeString,bb;for(byteString=dataURI.split(",")[0].indexOf("base64")>=0?atob(dataURI.split(",")[1]):decodeURIComponent(dataURI.split(",")[1]),arrayBuffer=new ArrayBuffer(byteString.length),intArray=new Uint8Array(arrayBuffer),i=0;i<byteString.length;i+=1)intArray[i]=byteString.charCodeAt(i);return mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0],hasBlobConstructor?new Blob([hasArrayBufferViewSupport?intArray:arrayBuffer],{type:mimeString}):(bb=new BlobBuilder,bb.append(arrayBuffer),bb.getBlob(mimeString))};window.HTMLCanvasElement&&!CanvasPrototype.toBlob&&(CanvasPrototype.mozGetAsFile?CanvasPrototype.toBlob=function(callback,type,quality){callback(quality&&CanvasPrototype.toDataURL&&dataURLtoBlob?dataURLtoBlob(this.toDataURL(type,quality)):this.mozGetAsFile("blob",type))}:CanvasPrototype.toDataURL&&dataURLtoBlob&&(CanvasPrototype.toBlob=function(callback,type,quality){callback(dataURLtoBlob(this.toDataURL(type,quality)))})),window.dataURLtoBlob=dataURLtoBlob}(window),function(window,undef){"use strict";function _emit(target,fn,name,res,ext){var evt={type:name.type||name,target:target,result:res};_extend(evt,ext),fn(evt)}function _hasSupportReadAs(as){return FileReader&&!!FileReader.prototype["readAs"+as]}function _readAs(file,fn,as,encoding){if(api.isBlob(file)&&_hasSupportReadAs(as)){var Reader=new FileReader;_on(Reader,_readerEvents,function _fn(evt){var type=evt.type;"progress"==type?_emit(file,fn,evt,evt.target.result,{loaded:evt.loaded,total:evt.total}):"loadend"==type?(_off(Reader,_readerEvents,_fn),Reader=null):_emit(file,fn,evt,evt.target.result)});try{encoding?Reader["readAs"+as](file,encoding):Reader["readAs"+as](file)}catch(err){_emit(file,fn,"error",undef,{error:err.toString()})}}else _emit(file,fn,"error",undef,{error:"FileReader_not_support_"+as})}function _isRegularFile(file,callback){if(!file.type&&file.size%4096===0&&file.size<=102400)if(FileReader)try{var Reader=new FileReader;_one(Reader,_readerEvents,function(evt){var isFile="error"!=evt.type;callback(isFile),isFile&&Reader.abort()}),Reader.readAsDataURL(file)}catch(err){callback(!1)}else callback(null);else callback(!0)}function _getAsEntry(item){var entry;return item.getAsEntry?entry=item.getAsEntry():item.webkitGetAsEntry&&(entry=item.webkitGetAsEntry()),entry}function _readEntryAsFiles(entry,callback){if(entry)if(entry.isFile)entry.file(function(file){file.fullPath=entry.fullPath,callback(!1,[file])},function(err){callback("FileError.code: "+err.code)});else if(entry.isDirectory){var reader=entry.createReader(),result=[];reader.readEntries(function(entries){api.afor(entries,function(next,entry){_readEntryAsFiles(entry,function(err,files){err?api.log(err):result=result.concat(files),next?next():callback(!1,result)})})},function(err){callback("directory_reader: "+err)})}else _readEntryAsFiles(_getAsEntry(entry),callback);else callback("invalid entry")}function _simpleClone(obj){var copy={};return _each(obj,function(val,key){val&&"object"==typeof val&&void 0===val.nodeType&&(val=_extend({},val)),copy[key]=val}),copy}function isInputFile(el){return _rinput.test(el&&el.tagName)}function _getDataTransfer(evt){return(evt.originalEvent||evt||"").dataTransfer||{}}function _isOriginTransform(trans){var key;for(key in trans)if(trans.hasOwnProperty(key)&&!(trans[key]instanceof Object||"overlay"===key||"filter"===key))return!0;return!1}var gid=1,noop=function(){},document=window.document,doctype=document.doctype||{},userAgent=window.navigator.userAgent,apiURL=window.createObjectURL&&window||window.URL&&URL.revokeObjectURL&&URL||window.webkitURL&&webkitURL,Blob=window.Blob,File=window.File,FileReader=window.FileReader,FormData=window.FormData,XMLHttpRequest=window.XMLHttpRequest,jQuery=window.jQuery,html5=!(!(File&&FileReader&&(window.Uint8Array||FormData||XMLHttpRequest.prototype.sendAsBinary))||/safari\//i.test(userAgent)&&!/chrome\//i.test(userAgent)&&/windows/i.test(userAgent)),cors=html5&&"withCredentials"in new XMLHttpRequest,chunked=html5&&!!Blob&&!!(Blob.prototype.webkitSlice||Blob.prototype.mozSlice||Blob.prototype.slice),dataURLtoBlob=window.dataURLtoBlob,_rimg=/img/i,_rcanvas=/canvas/i,_rimgcanvas=/img|canvas/i,_rinput=/input/i,_rdata=/^data:[^,]+,/,_toString={}.toString,Math=window.Math,_SIZE_CONST=function(pow){return pow=new window.Number(Math.pow(1024,pow)),pow.from=function(sz){return Math.round(sz*this)},pow},_elEvents={},_infoReader=[],_readerEvents="abort progress error load loadend",_xhrPropsExport="status statusText readyState response responseXML responseText responseBody".split(" "),currentTarget="currentTarget",preventDefault="preventDefault",_isArray=function(ar){return ar&&"length"in ar},_each=function(obj,fn,ctx){if(obj)if(_isArray(obj))for(var i=0,n=obj.length;i<n;i++)i in obj&&fn.call(ctx,obj[i],i,obj);else for(var key in obj)obj.hasOwnProperty(key)&&fn.call(ctx,obj[key],key,obj)},_extend=function(dst){for(var args=arguments,i=1,_ext=function(val,key){dst[key]=val};i<args.length;i++)_each(args[i],_ext);return dst},_on=function(el,type,fn){if(el){var uid=api.uid(el);_elEvents[uid]||(_elEvents[uid]={});var isFileReader=FileReader&&el&&el instanceof FileReader;_each(type.split(/\s+/),function(type){jQuery&&!isFileReader?jQuery.event.add(el,type,fn):(_elEvents[uid][type]||(_elEvents[uid][type]=[]),_elEvents[uid][type].push(fn),el.addEventListener?el.addEventListener(type,fn,!1):el.attachEvent?el.attachEvent("on"+type,fn):el["on"+type]=fn)})}},_off=function(el,type,fn){if(el){var uid=api.uid(el),events=_elEvents[uid]||{},isFileReader=FileReader&&el&&el instanceof FileReader;_each(type.split(/\s+/),function(type){if(jQuery&&!isFileReader)jQuery.event.remove(el,type,fn);else{for(var fns=events[type]||[],i=fns.length;i--;)if(fns[i]===fn){fns.splice(i,1);break}el.addEventListener?el.removeEventListener(type,fn,!1):el.detachEvent?el.detachEvent("on"+type,fn):el["on"+type]=null}})}},_one=function(el,type,fn){_on(el,type,function _(evt){_off(el,type,_),fn(evt)})},_fixEvent=function(evt){return evt.target||(evt.target=window.event&&window.event.srcElement||document),3===evt.target.nodeType&&(evt.target=evt.target.parentNode),evt},_supportInputAttr=function(attr){var input=document.createElement("input");return input.setAttribute("type","file"),attr in input},api={version:"2.0.7",cors:!1,html5:!0,media:!1,formData:!0,multiPassResize:!0,debug:!1,pingUrl:!1,multiFlash:!1,flashAbortTimeout:0,withCredentials:!0,staticPath:"./dist/",flashUrl:0,flashImageUrl:0,postNameConcat:function(name,idx){return name+(null!=idx?"["+idx+"]":"")},ext2mime:{jpg:"image/jpeg",tif:"image/tiff",txt:"text/plain"},accept:{"image/*":"art bm bmp dwg dxf cbr cbz fif fpx gif ico iefs jfif jpe jpeg jpg jps jut mcf nap nif pbm pcx pgm pict pm png pnm qif qtif ras rast rf rp svf tga tif tiff xbm xbm xpm xwd","audio/*":"m4a flac aac rm mpa wav wma ogg mp3 mp2 m3u mod amf dmf dsm far gdm imf it m15 med okt s3m stm sfx ult uni xm sid ac3 dts cue aif aiff wpl ape mac mpc mpp shn wv nsf spc gym adplug adx dsp adp ymf ast afc hps xs","video/*":"m4v 3gp nsv ts ty strm rm rmvb m3u ifo mov qt divx xvid bivx vob nrg img iso pva wmv asf asx ogm m2v avi bin dat dvr-ms mpg mpeg mp4 mkv avc vp3 svq3 nuv viv dv fli flv wpl"},uploadRetry:0,networkDownRetryTimeout:5e3,chunkSize:0,chunkUploadRetry:0,chunkNetworkDownRetryTimeout:2e3,KB:_SIZE_CONST(1),MB:_SIZE_CONST(2),GB:_SIZE_CONST(3),TB:_SIZE_CONST(4),EMPTY_PNG:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQIW2NkAAIAAAoAAggA9GkAAAAASUVORK5CYII=",expando:"fileapi"+(new Date).getTime(),uid:function(obj){return obj?obj[api.expando]=obj[api.expando]||api.uid():(++gid,api.expando+gid)},log:function(){api.debug&&api._supportConsoleLog&&(api._supportConsoleLogApply?console.log.apply(console,arguments):console.log([].join.call(arguments," ")))},newImage:function(src,fn){var img=document.createElement("img");return fn&&api.event.one(img,"error load",function(evt){fn("error"==evt.type,img),img=null}),img.src=src,img},getXHR:function(){var xhr;if(XMLHttpRequest)xhr=new XMLHttpRequest;else if(window.ActiveXObject)try{xhr=new ActiveXObject("MSXML2.XMLHttp.3.0")}catch(e){xhr=new ActiveXObject("Microsoft.XMLHTTP")}return xhr},isArray:_isArray,support:{dnd:cors&&"ondrop"in document.createElement("div"),cors:cors,html5:html5,chunked:chunked,dataURI:!0,accept:_supportInputAttr("accept"),multiple:_supportInputAttr("multiple")},event:{on:_on,off:_off,one:_one,fix:_fixEvent},throttle:function(fn,delay){var id,args;return function(){args=arguments,id||(fn.apply(window,args),id=setTimeout(function(){id=0,fn.apply(window,args)},delay))}},F:function(){},parseJSON:function(str){var json;return json=window.JSON&&JSON.parse?JSON.parse(str):new Function("return ("+str.replace(/([\r\n])/g,"\\$1")+");")()},trim:function(str){return str=String(str),str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")},defer:function(){var result,error,list=[],defer={resolve:function(err,res){for(defer.resolve=noop,error=err||!1,result=res;res=list.shift();)res(error,result)},then:function(fn){error!==undef?fn(error,result):list.push(fn)}};return defer},queue:function(fn){var _idx=0,_length=0,_fail=!1,_end=!1,queue={inc:function(){_length++},next:function(){_idx++,setTimeout(queue.check,0)},check:function(){_idx>=_length&&!_fail&&queue.end()},isFail:function(){return _fail},fail:function(){!_fail&&fn(_fail=!0)},end:function(){_end||(_end=!0,fn())}};return queue},each:_each,afor:function(array,callback){var i=0,n=array.length;_isArray(array)&&n--?!function _next(){callback(n!=i&&_next,array[i],i++)}():callback(!1)},extend:_extend,isFile:function(file){return"[object File]"===_toString.call(file)},isBlob:function(blob){return this.isFile(blob)||"[object Blob]"===_toString.call(blob)},isCanvas:function(el){return el&&_rcanvas.test(el.nodeName)},getFilesFilter:function(filter){return filter="string"==typeof filter?filter:filter.getAttribute&&filter.getAttribute("accept")||"",filter?new RegExp("("+filter.replace(/\./g,"\\.").replace(/,/g,"|")+")$","i"):/./},readAsDataURL:function(file,fn){api.isCanvas(file)?_emit(file,fn,"load",api.toDataURL(file)):_readAs(file,fn,"DataURL")},readAsBinaryString:function(file,fn){_hasSupportReadAs("BinaryString")?_readAs(file,fn,"BinaryString"):_readAs(file,function(evt){if("load"==evt.type)try{evt.result=api.toBinaryString(evt.result)}catch(e){evt.type="error",evt.message=e.toString()}fn(evt)},"DataURL")},readAsArrayBuffer:function(file,fn){_readAs(file,fn,"ArrayBuffer")},readAsText:function(file,encoding,fn){fn||(fn=encoding,encoding="utf-8"),_readAs(file,fn,"Text",encoding)},toDataURL:function(el,type){return"string"==typeof el?el:el.toDataURL?el.toDataURL(type||"image/png"):void 0},toBinaryString:function(val){return window.atob(api.toDataURL(val).replace(_rdata,""))},readAsImage:function(file,fn,progress){if(api.isFile(file))if(apiURL){var data=apiURL.createObjectURL(file);data===undef?_emit(file,fn,"error"):api.readAsImage(data,fn,progress)}else api.readAsDataURL(file,function(evt){"load"==evt.type?api.readAsImage(evt.result,fn,progress):(progress||"error"==evt.type)&&_emit(file,fn,evt,null,{loaded:evt.loaded,total:evt.total})});else if(api.isCanvas(file))_emit(file,fn,"load",file);else if(_rimg.test(file.nodeName))if(file.complete)_emit(file,fn,"load",file);else{var events="error abort load";_one(file,events,function _fn(evt){"load"==evt.type&&apiURL&&apiURL.revokeObjectURL(file.src),_off(file,events,_fn),_emit(file,fn,evt,file)})}else if(file.iframe)_emit(file,fn,{type:"error"});else{var img=api.newImage(file.dataURL||file);api.readAsImage(img,fn,progress)}},checkFileObj:function(name){var file={},accept=api.accept;return"object"==typeof name?file=name:file.name=(name+"").split(/\\|\//g).pop(),null==file.type&&(file.type=file.name.split(".").pop()),_each(accept,function(ext,type){ext=new RegExp(ext.replace(/\s/g,"|"),"i"),(ext.test(file.type)||api.ext2mime[file.type])&&(file.type=api.ext2mime[file.type]||type.split("/")[0]+"/"+file.type)}),file},getDropFiles:function(evt,callback){var files=[],dataTransfer=_getDataTransfer(evt),entrySupport=_isArray(dataTransfer.items)&&dataTransfer.items[0]&&_getAsEntry(dataTransfer.items[0]),queue=api.queue(function(){callback(files)});_each((entrySupport?dataTransfer.items:dataTransfer.files)||[],function(item){queue.inc();try{entrySupport?_readEntryAsFiles(item,function(err,entryFiles){err?api.log("[err] getDropFiles:",err):files.push.apply(files,entryFiles),queue.next()}):_isRegularFile(item,function(yes){yes&&files.push(item),queue.next()})}catch(err){queue.next(),api.log("[err] getDropFiles: ",err)}}),queue.check()},getFiles:function(input,filter,callback){var files=[];return callback?(api.filterFiles(api.getFiles(input),filter,callback),null):(input.jquery&&(input.each(function(){files=files.concat(api.getFiles(this))}),input=files,files=[]),"string"==typeof filter&&(filter=api.getFilesFilter(filter)),input.originalEvent?input=_fixEvent(input.originalEvent):input.srcElement&&(input=_fixEvent(input)),input.dataTransfer?input=input.dataTransfer:input.target&&(input=input.target),input.files?(files=input.files,html5||(files[0].blob=input,files[0].iframe=!0)):!html5&&isInputFile(input)?api.trim(input.value)&&(files=[api.checkFileObj(input.value)],files[0].blob=input,files[0].iframe=!0):_isArray(input)&&(files=input),api.filter(files,function(file){return!filter||filter.test(file.name)}))},getTotalSize:function(files){for(var size=0,i=files&&files.length;i--;)size+=files[i].size;return size},getInfo:function(file,fn){var info={},readers=_infoReader.concat();api.isFile(file)?!function _next(){var reader=readers.shift();reader?reader.test(file.type)?reader(file,function(err,res){err?fn(err):(_extend(info,res),_next())}):_next():fn(!1,info)}():fn("not_support_info",info)},addInfoReader:function(mime,fn){fn.test=function(type){return mime.test(type)},_infoReader.push(fn)},filter:function(input,fn){for(var val,result=[],i=0,n=input.length;i<n;i++)i in input&&(val=input[i],fn.call(val,val,i,input)&&result.push(val));return result},filterFiles:function(files,eachFn,resultFn){if(files.length){var file,queue=files.concat(),result=[],deleted=[];!function _next(){queue.length?(file=queue.shift(),api.getInfo(file,function(err,info){(eachFn(file,!err&&info)?result:deleted).push(file),_next()})):resultFn(result,deleted)}()}else resultFn([],files)},upload:function(options){options=_extend({jsonp:"callback",prepare:api.F,beforeupload:api.F,upload:api.F,fileupload:api.F,fileprogress:api.F,filecomplete:api.F,progress:api.F,complete:api.F,pause:api.F,imageOriginal:!0,chunkSize:api.chunkSize,chunkUploadRetry:api.chunkUploadRetry,uploadRetry:api.uploadRetry},options),options.imageAutoOrientation&&!options.imageTransform&&(options.imageTransform={rotate:"auto"});var _nextFile,proxyXHR=new api.XHR(options),dataArray=this._getFilesDataArray(options.files),_this=this,_total=0,_loaded=0,_complete=!1;return _each(dataArray,function(data){_total+=data.size}),proxyXHR.files=[],_each(dataArray,function(data){proxyXHR.files.push(data.file)}),proxyXHR.total=_total,proxyXHR.loaded=0,proxyXHR.filesLeft=dataArray.length,options.beforeupload(proxyXHR,options),_nextFile=function(){var data=dataArray.shift(),_file=data&&data.file,_fileLoaded=!1,_fileOptions=_simpleClone(options);if(proxyXHR.filesLeft=dataArray.length,_file&&_file.name===api.expando&&(_file=null,api.log("[warn] FileAPI.upload() — called without files")),("abort"!=proxyXHR.statusText||proxyXHR.current)&&data){if(_complete=!1,proxyXHR.currentFile=_file,_file&&options.prepare(_file,_fileOptions)===!1)return void _nextFile.call(_this);_fileOptions.file=_file,_this._getFormData(_fileOptions,data,function(form){_loaded||options.upload(proxyXHR,options);var xhr=new api.XHR(_extend({},_fileOptions,{upload:_file?function(){options.fileupload(_file,xhr,_fileOptions)}:noop,progress:_file?function(evt){_fileLoaded||(_fileLoaded=evt.loaded===evt.total,options.fileprogress({type:"progress",total:data.total=evt.total,loaded:data.loaded=evt.loaded},_file,xhr,_fileOptions),options.progress({type:"progress",total:_total,loaded:proxyXHR.loaded=_loaded+data.size*(evt.loaded/evt.total)|0},_file,xhr,_fileOptions))}:noop,complete:function(err){_each(_xhrPropsExport,function(name){proxyXHR[name]=xhr[name]}),_file&&(data.total=data.total||data.size,data.loaded=data.total,err||(this.progress(data),_fileLoaded=!0,_loaded+=data.size,proxyXHR.loaded=_loaded),options.filecomplete(err,xhr,_file,_fileOptions)),setTimeout(function(){_nextFile.call(_this)},0)}}));proxyXHR.abort=function(current){current||(dataArray.length=0),this.current=current,xhr.abort()},xhr.send(form)})}else{var successful=200==proxyXHR.status||201==proxyXHR.status||204==proxyXHR.status;options.complete(!successful&&(proxyXHR.statusText||"error"),proxyXHR,options),_complete=!0}},setTimeout(_nextFile,0),proxyXHR.append=function(files,first){files=api._getFilesDataArray([].concat(files)),_each(files,function(data){_total+=data.size,proxyXHR.files.push(data.file),first?dataArray.unshift(data):dataArray.push(data)}),proxyXHR.statusText="",_complete&&_nextFile.call(_this)},proxyXHR.remove=function(file){for(var _file,i=dataArray.length;i--;)dataArray[i].file==file&&(_file=dataArray.splice(i,1),_total-=_file.size);return _file},proxyXHR},_getFilesDataArray:function(data){var files=[],oFiles={};if(isInputFile(data)){var tmp=api.getFiles(data);oFiles[data.name||"file"]=null!==data.getAttribute("multiple")?tmp:tmp[0]}else _isArray(data)&&isInputFile(data[0])?_each(data,function(input){oFiles[input.name||"file"]=api.getFiles(input)}):oFiles=data;return _each(oFiles,function add(file,name){_isArray(file)?_each(file,function(file){add(file,name)}):file&&(file.name||file.image)&&files.push({name:name,file:file,size:file.size,total:file.size,loaded:0})}),files.length||files.push({file:{name:api.expando}}),files},_getFormData:function(options,data,fn){var file=data.file,name=data.name,filename=file.name,filetype=file.type,trans=api.support.transform&&options.imageTransform,Form=new api.Form,queue=api.queue(function(){fn(Form)}),isOrignTrans=trans&&_isOriginTransform(trans),postNameConcat=api.postNameConcat;_each(options.data,function add(val,name){"object"==typeof val?_each(val,function(v,i){add(v,postNameConcat(name,i))}):Form.append(name,val)}),function _addFile(file){file.image?(queue.inc(),file.toData(function(err,image){filename=filename||(new Date).getTime()+".png",_addFile(image),queue.next()})):api.Image&&trans&&(/^image/.test(file.type)||_rimgcanvas.test(file.nodeName))?(queue.inc(),isOrignTrans&&(trans=[trans]),api.Image.transform(file,trans,options.imageAutoOrientation,function(err,images){if(isOrignTrans&&!err)dataURLtoBlob||api.flashEngine||(Form.multipart=!0),Form.append(name,images[0],filename,trans[0].type||filetype);else{var addOrigin=0;err||_each(images,function(image,idx){dataURLtoBlob||api.flashEngine||(Form.multipart=!0),trans[idx].postName||(addOrigin=1),Form.append(trans[idx].postName||postNameConcat(name,idx),image,filename,trans[idx].type||filetype)}),(err||options.imageOriginal)&&Form.append(postNameConcat(name,addOrigin?"original":null),file,filename,filetype)}queue.next()})):filename!==api.expando&&Form.append(name,file,filename)}(file),queue.check()},reset:function(inp,notRemove){var parent,clone;return jQuery?(clone=jQuery(inp).clone(!0).insertBefore(inp).val("")[0],notRemove||jQuery(inp).remove()):(parent=inp.parentNode,clone=parent.insertBefore(inp.cloneNode(!0),inp),clone.value="",notRemove||parent.removeChild(inp),_each(_elEvents[api.uid(inp)],function(fns,type){_each(fns,function(fn){_off(inp,type,fn),_on(clone,type,fn)})})),clone},load:function(url,fn){var xhr=api.getXHR();return xhr?(xhr.open("GET",url,!0),xhr.overrideMimeType&&xhr.overrideMimeType("text/plain; charset=x-user-defined"),_on(xhr,"progress",function(evt){evt.lengthComputable&&fn({type:evt.type,loaded:evt.loaded,total:evt.total},xhr)}),xhr.onreadystatechange=function(){if(4==xhr.readyState)if(xhr.onreadystatechange=null,200==xhr.status){url=url.split("/");var file={name:url[url.length-1],size:xhr.getResponseHeader("Content-Length"),type:xhr.getResponseHeader("Content-Type")};file.dataURL="data:"+file.type+";base64,"+api.encode64(xhr.responseBody||xhr.responseText),fn({type:"load",result:file},xhr)}else fn({type:"error"},xhr)},xhr.send(null)):fn({type:"error"}),xhr},encode64:function(str){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",outStr="",i=0;for("string"!=typeof str&&(str=String(str));i<str.length;){var enc3,enc4,byte1=255&str.charCodeAt(i++),byte2=255&str.charCodeAt(i++),byte3=255&str.charCodeAt(i++),enc1=byte1>>2,enc2=(3&byte1)<<4|byte2>>4;isNaN(byte2)?enc3=enc4=64:(enc3=(15&byte2)<<2|byte3>>6,enc4=isNaN(byte3)?64:63&byte3),outStr+=b64.charAt(enc1)+b64.charAt(enc2)+b64.charAt(enc3)+b64.charAt(enc4)}return outStr}};api.addInfoReader(/^image/,function(file,callback){if(!file.__dimensions){var defer=file.__dimensions=api.defer();api.readAsImage(file,function(evt){var img=evt.target;defer.resolve("load"!=evt.type&&"error",{width:img.width,height:img.height}),img.src=api.EMPTY_PNG,img=null})}file.__dimensions.then(callback)}),api.event.dnd=function(el,onHover,onDrop){var _id,_type;onDrop||(onDrop=onHover,onHover=api.F),FileReader?(_on(el,"dragenter dragleave dragover",onHover.ff=onHover.ff||function(evt){for(var types=_getDataTransfer(evt).types,i=types&&types.length,debounceTrigger=!1;i--;)if(~types[i].indexOf("File")){evt[preventDefault](),_type!==evt.type&&(_type=evt.type,"dragleave"!=_type&&onHover.call(evt[currentTarget],!0,evt),debounceTrigger=!0);break}debounceTrigger&&(clearTimeout(_id),_id=setTimeout(function(){onHover.call(evt[currentTarget],"dragleave"!=_type,evt)},50))}),_on(el,"drop",onDrop.ff=onDrop.ff||function(evt){evt[preventDefault](),_type=0,onHover.call(evt[currentTarget],!1,evt),api.getDropFiles(evt,function(files){onDrop.call(evt[currentTarget],files,evt)})})):api.log("Drag'n'Drop -- not supported")},api.event.dnd.off=function(el,onHover,onDrop){_off(el,"dragenter dragleave dragover",onHover.ff),_off(el,"drop",onDrop.ff)},jQuery&&!jQuery.fn.dnd&&(jQuery.fn.dnd=function(onHover,onDrop){return this.each(function(){api.event.dnd(this,onHover,onDrop)})},jQuery.fn.offdnd=function(onHover,onDrop){return this.each(function(){api.event.dnd.off(this,onHover,onDrop)})}),window.FileAPI=_extend(api,window.FileAPI),api.log("FileAPI: "+api.version),api.log("protocol: "+window.location.protocol),api.log("doctype: ["+doctype.name+"] "+doctype.publicId+" "+doctype.systemId),_each(document.getElementsByTagName("meta"),function(meta){/x-ua-compatible/i.test(meta.getAttribute("http-equiv"))&&api.log("meta.http-equiv: "+meta.getAttribute("content"))});try{api._supportConsoleLog=!!console.log,api._supportConsoleLogApply=!!console.log.apply}catch(err){}api.flashUrl||(api.flashUrl=api.staticPath+"FileAPI.flash.swf"),api.flashImageUrl||(api.flashImageUrl=api.staticPath+"FileAPI.flash.image.swf"),api.flashWebcamUrl||(api.flashWebcamUrl=api.staticPath+"FileAPI.flash.camera.swf")}(window,void 0),function(api,document,undef){"use strict";function Image(file){if(file instanceof Image){var img=new Image(file.file);return api.extend(img.matrix,file.matrix),img}return this instanceof Image?(this.file=file,this.size=file.size||100,void(this.matrix={sx:0,sy:0,sw:0,sh:0,dx:0,dy:0,dw:0,dh:0,resize:0,deg:0,quality:1,filter:0})):new Image(file)}var min=Math.min,round=Math.round,getCanvas=function(){return document.createElement("canvas")},support=!1,exifOrientation={8:270,3:180,6:90,7:270,4:180,5:90};try{support=getCanvas().toDataURL("image/png").indexOf("data:image/png")>-1}catch(e){}Image.prototype={image:!0,constructor:Image,set:function(attrs){return api.extend(this.matrix,attrs),this},crop:function(x,y,w,h){return w===undef&&(w=x,h=y,x=y=0),this.set({sx:x,sy:y,sw:w,sh:h||w})},resize:function(w,h,strategy){return/min|max/.test(h)&&(strategy=h,h=w),this.set({dw:w,dh:h||w,resize:strategy})},preview:function(w,h){return this.resize(w,h||w,"preview")},rotate:function(deg){return this.set({deg:deg})},filter:function(filter){return this.set({filter:filter})},overlay:function(images){return this.set({overlay:images})},clone:function(){return new Image(this)},_load:function(image,fn){var self=this;/img|video/i.test(image.nodeName)?fn.call(self,null,image):api.readAsImage(image,function(evt){fn.call(self,"load"!=evt.type,evt.result)})},_apply:function(image,fn){var copy,canvas=getCanvas(),m=this.getMatrix(image),ctx=canvas.getContext("2d"),width=image.videoWidth||image.width,height=image.videoHeight||image.height,deg=m.deg,dw=m.dw,dh=m.dh,w=width,h=height,filter=m.filter,buffer=image,overlay=m.overlay,queue=api.queue(function(){image.src=api.EMPTY_PNG,fn(!1,canvas)}),renderImageToCanvas=api.renderImageToCanvas;for(deg-=360*Math.floor(deg/360),image._type=this.file.type;m.multipass&&min(w/dw,h/dh)>2;)w=w/2+.5|0,h=h/2+.5|0,copy=getCanvas(),copy.width=w,copy.height=h,buffer!==image?(renderImageToCanvas(copy,buffer,0,0,buffer.width,buffer.height,0,0,w,h),buffer=copy):(buffer=copy,renderImageToCanvas(buffer,image,m.sx,m.sy,m.sw,m.sh,0,0,w,h),m.sx=m.sy=m.sw=m.sh=0);canvas.width=deg%180?dh:dw,canvas.height=deg%180?dw:dh,canvas.type=m.type,canvas.quality=m.quality,ctx.rotate(deg*Math.PI/180),renderImageToCanvas(ctx.canvas,buffer,m.sx,m.sy,m.sw||buffer.width,m.sh||buffer.height,180==deg||270==deg?-dw:0,90==deg||180==deg?-dh:0,dw,dh),dw=canvas.width,dh=canvas.height,overlay&&api.each([].concat(overlay),function(over){queue.inc();var img=new window.Image,fn=function(){var x=0|over.x,y=0|over.y,w=over.w||img.width,h=over.h||img.height,rel=over.rel;x=1==rel||4==rel||7==rel?(dw-w+x)/2:2==rel||5==rel||8==rel?dw-(w+x):x,y=3==rel||4==rel||5==rel?(dh-h+y)/2:rel>=6?dh-(h+y):y,api.event.off(img,"error load abort",fn);try{ctx.globalAlpha=over.opacity||1,ctx.drawImage(img,x,y,w,h)}catch(er){}queue.next()};api.event.on(img,"error load abort",fn),img.src=over.src,img.complete&&fn()}),filter&&(queue.inc(),Image.applyFilter(canvas,filter,queue.next)),queue.check()},getMatrix:function(image){var m=api.extend({},this.matrix),sw=m.sw=m.sw||image.videoWidth||image.naturalWidth||image.width,sh=m.sh=m.sh||image.videoHeight||image.naturalHeight||image.height,dw=m.dw=m.dw||sw,dh=m.dh=m.dh||sh,sf=sw/sh,df=dw/dh,strategy=m.resize;if("preview"==strategy){if(dw!=sw||dh!=sh){var w,h;df>=sf?(w=sw,h=w/df):(h=sh,w=h*df),w==sw&&h==sh||(m.sx=~~((sw-w)/2),m.sy=~~((sh-h)/2),sw=w,sh=h)}}else strategy&&(sw>dw||sh>dh?"min"==strategy?(dw=round(sf<df?min(sw,dw):dh*sf),dh=round(sf<df?dw/sf:min(sh,dh))):(dw=round(sf>=df?min(sw,dw):dh*sf),dh=round(sf>=df?dw/sf:min(sh,dh))):(dw=sw,dh=sh));return m.sw=sw,m.sh=sh,m.dw=dw,m.dh=dh,m.multipass=api.multiPassResize,m},_trans:function(fn){this._load(this.file,function(err,image){if(err)fn(err);else try{this._apply(image,fn)}catch(err){api.log("[err] FileAPI.Image.fn._apply:",err),fn(err)}})},get:function(fn){if(api.support.transform){var _this=this,matrix=_this.matrix;"auto"==matrix.deg?api.getInfo(_this.file,function(err,info){matrix.deg=exifOrientation[info&&info.exif&&info.exif.Orientation]||0,_this._trans(fn)}):_this._trans(fn)}else fn("not_support_transform");return this},toData:function(fn){return this.get(fn)}},Image.exifOrientation=exifOrientation,Image.transform=function(file,transform,autoOrientation,fn){function _transform(err,img){var images={},queue=api.queue(function(err){fn(err,images)});err?queue.fail():api.each(transform,function(params,name){if(!queue.isFail()){var ImgTrans=new Image(img.nodeType?img:file),isFn="function"==typeof params;if(isFn?params(img,ImgTrans):params.width?ImgTrans[params.preview?"preview":"resize"](params.width,params.height,params.strategy):params.maxWidth&&(img.width>params.maxWidth||img.height>params.maxHeight)&&ImgTrans.resize(params.maxWidth,params.maxHeight,"max"),params.crop){var crop=params.crop;ImgTrans.crop(0|crop.x,0|crop.y,crop.w||crop.width,crop.h||crop.height)}params.rotate===undef&&autoOrientation&&(params.rotate="auto"),ImgTrans.set({type:ImgTrans.matrix.type||params.type||file.type||"image/png"}),isFn||ImgTrans.set({deg:params.rotate,overlay:params.overlay,filter:params.filter,quality:params.quality||1}),queue.inc(),ImgTrans.toData(function(err,image){err?queue.fail():(images[name]=image,queue.next())})}})}file.width?_transform(!1,file):api.getInfo(file,_transform)},api.each(["TOP","CENTER","BOTTOM"],function(x,i){api.each(["LEFT","CENTER","RIGHT"],function(y,j){Image[x+"_"+y]=3*i+j,Image[y+"_"+x]=3*i+j})}),Image.toCanvas=function(el){var canvas=document.createElement("canvas");return canvas.width=el.videoWidth||el.width,canvas.height=el.videoHeight||el.height,canvas.getContext("2d").drawImage(el,0,0),canvas},Image.fromDataURL=function(dataURL,size,callback){var img=api.newImage(dataURL);api.extend(img,size),callback(img)},Image.applyFilter=function(canvas,filter,doneFn){"function"==typeof filter?filter(canvas,doneFn):window.Caman&&window.Caman("IMG"==canvas.tagName?Image.toCanvas(canvas):canvas,function(){"string"==typeof filter?this[filter]():api.each(filter,function(val,method){this[method](val)},this),this.render(doneFn)})},api.renderImageToCanvas=function(canvas,img,sx,sy,sw,sh,dx,dy,dw,dh){try{return canvas.getContext("2d").drawImage(img,sx,sy,sw,sh,dx,dy,dw,dh)}catch(ex){throw api.log("renderImageToCanvas failed"),ex}},api.support.canvas=api.support.transform=support,api.Image=Image}(FileAPI,document),/*
 * JavaScript Load Image iOS scaling fixes 1.0.3
 * https://github.com/blueimp/JavaScript-Load-Image
 *
 * Copyright 2013, Sebastian Tschan
 * https://blueimp.net
 *
 * iOS image scaling fixes based on
 * https://github.com/stomita/ios-imagefile-megapixel
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
function(factory){"use strict";factory(FileAPI)}(function(loadImage){"use strict";if(window.navigator&&window.navigator.platform&&/iP(hone|od|ad)/.test(window.navigator.platform)){var originalRenderMethod=loadImage.renderImageToCanvas;loadImage.detectSubsampling=function(img){var canvas,context;return img.width*img.height>1048576&&(canvas=document.createElement("canvas"),canvas.width=canvas.height=1,context=canvas.getContext("2d"),context.drawImage(img,-img.width+1,0),0===context.getImageData(0,0,1,1).data[3])},loadImage.detectVerticalSquash=function(img,subsampled){var data,sy,ey,py,alpha,naturalHeight=img.naturalHeight||img.height,canvas=document.createElement("canvas"),context=canvas.getContext("2d");for(subsampled&&(naturalHeight/=2),canvas.width=1,canvas.height=naturalHeight,context.drawImage(img,0,0),data=context.getImageData(0,0,1,naturalHeight).data,sy=0,ey=naturalHeight,py=naturalHeight;py>sy;)alpha=data[4*(py-1)+3],0===alpha?ey=py:sy=py,py=ey+sy>>1;return py/naturalHeight||1},loadImage.renderImageToCanvas=function(canvas,img,sourceX,sourceY,sourceWidth,sourceHeight,destX,destY,destWidth,destHeight){if("image/jpeg"===img._type){var subsampled,vertSquashRatio,tileX,tileY,context=canvas.getContext("2d"),tmpCanvas=document.createElement("canvas"),tileSize=1024,tmpContext=tmpCanvas.getContext("2d");if(tmpCanvas.width=tileSize,tmpCanvas.height=tileSize,context.save(),subsampled=loadImage.detectSubsampling(img),subsampled&&(sourceX/=2,sourceY/=2,sourceWidth/=2,sourceHeight/=2),vertSquashRatio=loadImage.detectVerticalSquash(img,subsampled),subsampled||1!==vertSquashRatio){for(sourceY*=vertSquashRatio,destWidth=Math.ceil(tileSize*destWidth/sourceWidth),destHeight=Math.ceil(tileSize*destHeight/sourceHeight/vertSquashRatio),destY=0,tileY=0;tileY<sourceHeight;){for(destX=0,tileX=0;tileX<sourceWidth;)tmpContext.clearRect(0,0,tileSize,tileSize),tmpContext.drawImage(img,sourceX,sourceY,sourceWidth,sourceHeight,-tileX,-tileY,sourceWidth,sourceHeight),context.drawImage(tmpCanvas,0,0,tileSize,tileSize,destX,destY,destWidth,destHeight),tileX+=tileSize,destX+=destWidth;tileY+=tileSize,destY+=destHeight}return context.restore(),canvas}}return originalRenderMethod(canvas,img,sourceX,sourceY,sourceWidth,sourceHeight,destX,destY,destWidth,destHeight)}}}),function(api,window){"use strict";function _convertFile(file,fn,useBinaryString){var blob=file.blob,filename=file.file;if(filename){if(!blob.toDataURL)return void api.readAsBinaryString(blob,function(evt){"load"==evt.type&&fn(file,evt.result)});var mime={"image/jpeg":".jpe?g","image/png":".png"},type=mime[file.type]?file.type:"image/png",ext=mime[type]||".png",quality=blob.quality||1;filename.match(new RegExp(ext+"$","i"))||(filename+=ext.replace("?","")),file.file=filename,file.type=type,!useBinaryString&&blob.toBlob?blob.toBlob(function(blob){fn(file,blob)},type,quality):fn(file,api.toBinaryString(blob.toDataURL(type,quality)))}else fn(file,blob)}var document=window.document,FormData=window.FormData,Form=function(){this.items=[]},encodeURIComponent=window.encodeURIComponent;Form.prototype={append:function(name,blob,file,type){this.items.push({name:name,blob:blob&&blob.blob||(void 0==blob?"":blob),file:blob&&(file||blob.name),type:blob&&(type||blob.type)})},each:function(fn){for(var i=0,n=this.items.length;i<n;i++)fn.call(this,this.items[i])},toData:function(fn,options){options._chunked=api.support.chunked&&options.chunkSize>0&&1==api.filter(this.items,function(item){return item.file}).length,api.support.html5?api.formData&&!this.multipart&&FormData?options._chunked?(api.log("FileAPI.Form.toPlainData"),this.toPlainData(fn)):(api.log("FileAPI.Form.toFormData"),this.toFormData(fn)):(api.log("FileAPI.Form.toMultipartData"),this.toMultipartData(fn)):(api.log("FileAPI.Form.toHtmlData"),this.toHtmlData(fn))},_to:function(data,complete,next,arg){var queue=api.queue(function(){complete(data)});this.each(function(file){next(file,data,queue,arg)}),queue.check()},toHtmlData:function(fn){this._to(document.createDocumentFragment(),fn,function(file,data){var hidden,blob=file.blob;file.file?(api.reset(blob,!0),blob.name=file.name,blob.disabled=!1,data.appendChild(blob)):(hidden=document.createElement("input"),hidden.name=file.name,hidden.type="hidden",hidden.value=blob,data.appendChild(hidden))})},toPlainData:function(fn){this._to({},fn,function(file,data,queue){file.file&&(data.type=file.file),file.blob.toBlob?(queue.inc(),_convertFile(file,function(file,blob){data.name=file.name,data.file=blob,data.size=blob.length,data.type=file.type,queue.next()})):file.file?(data.name=file.blob.name,data.file=file.blob,data.size=file.blob.size,data.type=file.type):(data.params||(data.params=[]),data.params.push(encodeURIComponent(file.name)+"="+encodeURIComponent(file.blob))),data.start=-1,data.end=data.file&&data.file.FileAPIReadPosition||-1,data.retry=0})},toFormData:function(fn){this._to(new FormData,fn,function(file,data,queue){file.blob&&file.blob.toBlob?(queue.inc(),_convertFile(file,function(file,blob){data.append(file.name,blob,file.file),queue.next()})):file.file?data.append(file.name,file.blob,file.file):data.append(file.name,file.blob),file.file&&data.append("_"+file.name,file.file)})},toMultipartData:function(fn){this._to([],fn,function(file,data,queue,boundary){queue.inc(),_convertFile(file,function(file,blob){data.push("--_"+boundary+('\r\nContent-Disposition: form-data; name="'+file.name+'"'+(file.file?'; filename="'+encodeURIComponent(file.file)+'"':"")+(file.file?"\r\nContent-Type: "+(file.type||"application/octet-stream"):"")+"\r\n\r\n"+(file.file?blob:encodeURIComponent(blob))+"\r\n")),queue.next()},!0)},api.expando)}},api.Form=Form}(FileAPI,window),function(window,api){"use strict";var noop=function(){},document=window.document,XHR=function(options){this.uid=api.uid(),this.xhr={abort:noop,getResponseHeader:noop,getAllResponseHeaders:noop},this.options=options},_xhrResponsePostfix={"":1,XML:1,Text:1,Body:1};XHR.prototype={status:0,statusText:"",constructor:XHR,getResponseHeader:function(name){return this.xhr.getResponseHeader(name)},getAllResponseHeaders:function(){return this.xhr.getAllResponseHeaders()||{}},end:function(status,statusText){var _this=this,options=_this.options;_this.end=_this.abort=noop,_this.status=status,statusText&&(_this.statusText=statusText),api.log("xhr.end:",status,statusText),options.complete(200!=status&&201!=status&&(_this.statusText||"unknown"),_this),_this.xhr&&_this.xhr.node&&setTimeout(function(){var node=_this.xhr.node;try{node.parentNode.removeChild(node)}catch(e){}try{delete window[_this.uid]}catch(e){}window[_this.uid]=_this.xhr.node=null},9)},abort:function(){this.end(0,"abort"),this.xhr&&(this.xhr.aborted=!0,this.xhr.abort())},send:function(FormData){var _this=this,options=this.options;FormData.toData(function(data){options.upload(options,_this),_this._send.call(_this,options,data)},options)},_send:function(options,data){var xhr,_this=this,uid=_this.uid,onloadFuncName=_this.uid+"Load",url=options.url;if(api.log("XHR._send:",data),options.cache||(url+=(~url.indexOf("?")?"&":"?")+api.uid()),data.nodeName){var jsonp=options.jsonp;url=url.replace(/([a-z]+)=(\?)/i,"$1="+uid),options.upload(options,_this);var onPostMessage=function(evt){if(~url.indexOf(evt.origin))try{var result=api.parseJSON(evt.data);result.id==uid&&complete(result.status,result.statusText,result.response)}catch(err){complete(0,err.message)}},complete=window[uid]=function(status,statusText,response){_this.readyState=4,_this.responseText=response,_this.end(status,statusText),api.event.off(window,"message",onPostMessage),window[uid]=xhr=transport=window[onloadFuncName]=null};_this.xhr.abort=function(){try{transport.stop?transport.stop():transport.contentWindow.stop?transport.contentWindow.stop():transport.contentWindow.document.execCommand("Stop")}catch(er){}complete(0,"abort")},api.event.on(window,"message",onPostMessage),window[onloadFuncName]=function(){try{var win=transport.contentWindow,doc=win.document,result=win.result||api.parseJSON(doc.body.innerHTML);complete(result.status,result.statusText,result.response)}catch(e){api.log("[transport.onload]",e)}},xhr=document.createElement("div"),xhr.innerHTML='<form target="'+uid+'" action="'+url+'" method="POST" enctype="multipart/form-data" style="position: absolute; top: -1000px; overflow: hidden; width: 1px; height: 1px;"><iframe name="'+uid+'" src="javascript:false;" onload="'+onloadFuncName+'()"></iframe>'+(jsonp&&options.url.indexOf("=?")<0?'<input value="'+uid+'" name="'+jsonp+'" type="hidden"/>':"")+"</form>";var form=xhr.getElementsByTagName("form")[0],transport=xhr.getElementsByTagName("iframe")[0];form.appendChild(data),api.log(form.parentNode.innerHTML),document.body.appendChild(xhr),_this.xhr.node=xhr,_this.readyState=2,form.submit(),form=null}else{if(url=url.replace(/([a-z]+)=(\?)&?/i,""),this.xhr&&this.xhr.aborted)return void api.log("Error: already aborted");if(xhr=_this.xhr=api.getXHR(),data.params&&(url+=(url.indexOf("?")<0?"?":"&")+data.params.join("&")),xhr.open("POST",url,!0),api.withCredentials&&(xhr.withCredentials="true"),options.headers&&options.headers["X-Requested-With"]||xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),api.each(options.headers,function(val,key){xhr.setRequestHeader(key,val)}),options._chunked){xhr.upload&&xhr.upload.addEventListener("progress",api.throttle(function(evt){data.retry||options.progress({type:evt.type,total:data.size,loaded:data.start+evt.loaded,totalSize:data.size},_this,options)},100),!1),xhr.onreadystatechange=function(){var lkb=parseInt(xhr.getResponseHeader("X-Last-Known-Byte"),10);if(_this.status=xhr.status,_this.statusText=xhr.statusText,_this.readyState=xhr.readyState,4==xhr.readyState){try{for(var k in _xhrResponsePostfix)_this["response"+k]=xhr["response"+k]}catch(_){}if(xhr.onreadystatechange=null,!xhr.status||xhr.status-201>0)if(api.log("Error: "+xhr.status),(!xhr.status&&!xhr.aborted||500==xhr.status||416==xhr.status)&&++data.retry<=options.chunkUploadRetry){var delay=xhr.status?0:api.chunkNetworkDownRetryTimeout;options.pause(data.file,options),api.log("X-Last-Known-Byte: "+lkb),lkb?data.end=lkb:(data.end=data.start-1,416==xhr.status&&(data.end=data.end-options.chunkSize)),setTimeout(function(){_this._send(options,data)},delay)}else _this.end(xhr.status);else data.retry=0,data.end==data.size-1?_this.end(xhr.status):(api.log("X-Last-Known-Byte: "+lkb),lkb&&(data.end=lkb),data.file.FileAPIReadPosition=data.end,setTimeout(function(){_this._send(options,data)},0));xhr=null}},data.start=data.end+1,data.end=Math.max(Math.min(data.start+options.chunkSize,data.size)-1,data.start);var file=data.file,slice=(file.slice||file.mozSlice||file.webkitSlice).call(file,data.start,data.end+1);data.size&&!slice.size?setTimeout(function(){_this.end(-1)}):(xhr.setRequestHeader("Content-Range","bytes "+data.start+"-"+data.end+"/"+data.size),xhr.setRequestHeader("Content-Disposition","attachment; filename="+encodeURIComponent(data.name)),xhr.setRequestHeader("Content-Type",data.type||"application/octet-stream"),xhr.send(slice)),file=slice=null}else if(xhr.upload&&xhr.upload.addEventListener("progress",api.throttle(function(evt){options.progress(evt,_this,options)},100),!1),xhr.onreadystatechange=function(){if(_this.status=xhr.status,_this.statusText=xhr.statusText,_this.readyState=xhr.readyState,4==xhr.readyState){for(var k in _xhrResponsePostfix)_this["response"+k]=xhr["response"+k];if(xhr.onreadystatechange=null,!xhr.status||xhr.status>201)if(api.log("Error: "+xhr.status),(!xhr.status&&!xhr.aborted||500==xhr.status)&&(options.retry||0)<options.uploadRetry){options.retry=(options.retry||0)+1;var delay=api.networkDownRetryTimeout;options.pause(options.file,options),setTimeout(function(){_this._send(options,data)},delay)}else _this.end(xhr.status);else _this.end(xhr.status);xhr=null}},api.isArray(data)){xhr.setRequestHeader("Content-Type","multipart/form-data; boundary=_"+api.expando);var rawData=data.join("")+"--_"+api.expando+"--";if(xhr.sendAsBinary)xhr.sendAsBinary(rawData);else{var bytes=Array.prototype.map.call(rawData,function(c){return 255&c.charCodeAt(0)});xhr.send(new Uint8Array(bytes).buffer)}}else xhr.send(data)}}},api.XHR=XHR}(window,FileAPI),function(window,api){"use strict";function _px(val){return val>=0?val+"px":val}function _detectVideoSignal(video){var ctx,canvas=document.createElement("canvas"),res=!1;try{ctx=canvas.getContext("2d"),ctx.drawImage(video,0,0,1,1),res=255!=ctx.getImageData(0,0,1,1).data[4]}catch(e){}return res}var URL=window.URL||window.webkitURL,document=window.document,navigator=window.navigator,getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,html5=!!getMedia;api.support.media=html5;var Camera=function(video){this.video=video};Camera.prototype={isActive:function(){return!!this._active},start:function(callback){var _successId,_failId,_this=this,video=_this.video,_complete=function(err){_this._active=!err,clearTimeout(_failId),clearTimeout(_successId),callback&&callback(err,_this)};getMedia.call(navigator,{video:!0},function(stream){_this.stream=stream,video.src=URL.createObjectURL(stream),_successId=setInterval(function(){_detectVideoSignal(video)&&_complete(null)},1e3),_failId=setTimeout(function(){_complete("timeout")},5e3),video.play()},_complete)},stop:function(){try{this._active=!1,this.video.pause(),this.stream.stop()}catch(err){}},shot:function(){return new Shot(this.video)}},Camera.get=function(el){return new Camera(el.firstChild)},Camera.publish=function(el,options,callback){"function"==typeof options&&(callback=options,options={}),options=api.extend({},{width:"100%",height:"100%",start:!0},options),el.jquery&&(el=el[0]);var doneFn=function(err){if(err)callback(err);else{var cam=Camera.get(el);options.start?cam.start(callback):callback(null,cam)}};if(el.style.width=_px(options.width),el.style.height=_px(options.height),api.html5&&html5){var video=document.createElement("video");video.style.width=_px(options.width),video.style.height=_px(options.height),window.jQuery?jQuery(el).empty():el.innerHTML="",el.appendChild(video),doneFn()}else Camera.fallback(el,options,doneFn)},Camera.fallback=function(el,options,callback){callback("not_support_camera")};var Shot=function(video){var canvas=video.nodeName?api.Image.toCanvas(video):video,shot=api.Image(canvas);return shot.type="image/png",shot.width=canvas.width,shot.height=canvas.height,shot.size=canvas.width*canvas.height*4,shot};Camera.Shot=Shot,api.Camera=Camera}(window,FileAPI),function(window,jQuery,api){"use strict";var document=window.document,location=window.location,navigator=window.navigator,_each=api.each;api.support.flash=function(){var mime=navigator.mimeTypes,has=!1;if(navigator.plugins&&"object"==typeof navigator.plugins["Shockwave Flash"])has=navigator.plugins["Shockwave Flash"].description&&!(mime&&mime["application/x-shockwave-flash"]&&!mime["application/x-shockwave-flash"].enabledPlugin);else try{has=!(!window.ActiveXObject||!new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(er){api.log("Flash -- does not supported.")}return has&&/^file:/i.test(location)&&api.log("[warn] Flash does not work on `file:` protocol."),has}(),api.support.flash&&(!api.html5||!api.support.html5||api.cors&&!api.support.cors||api.media&&!api.support.media)&&function(){function _makeFlashHTML(opts){return('<object id="#id#" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="'+(opts.width||"100%")+'" height="'+(opts.height||"100%")+'"><param name="movie" value="#src#" /><param name="flashvars" value="#flashvars#" /><param name="swliveconnect" value="true" /><param name="allowscriptaccess" value="always" /><param name="allownetworking" value="all" /><param name="menu" value="false" /><param name="wmode" value="#wmode#" /><embed flashvars="#flashvars#" swliveconnect="true" allownetworking="all" allowscriptaccess="always" name="#id#" src="#src#" width="'+(opts.width||"100%")+'" height="'+(opts.height||"100%")+'" menu="false" wmode="transparent" type="application/x-shockwave-flash"></embed></object>').replace(/#(\w+)#/gi,function(a,name){return opts[name]})}function _css(el,css){if(el&&el.style){var key,val;for(key in css){val=css[key],"number"==typeof val&&(val+="px");try{el.style[key]=val}catch(e){}}}}function _inherit(obj,methods){_each(methods,function(fn,name){var prev=obj[name];obj[name]=function(){return this.parent=prev,fn.apply(this,arguments)}})}function _isHtmlFile(file){return file&&!file.flashId}function _wrap(fn){var id=fn.wid=api.uid();return flash._fn[id]=fn,"FileAPI.Flash._fn."+id}function _unwrap(fn){try{flash._fn[fn.wid]=null,delete flash._fn[fn.wid]}catch(e){}}function _getUrl(url,params){if(!_rhttp.test(url)){if(/^\.\//.test(url)||"/"!=url.charAt(0)){var path=location.pathname;path=path.substr(0,path.lastIndexOf("/")),url=(path+"/"+url).replace("/./","/")}"//"!=url.substr(0,2)&&(url="//"+location.host+url),_rhttp.test(url)||(url=location.protocol+url)}return params&&(url+=(/\?/.test(url)?"&":"?")+params),url}function _makeFlashImage(opts,base64,fn){function _setImage(){try{var img=flash.get(flashId);img.setImage(base64)}catch(e){api.log('[err] FlashAPI.Preview.setImage -- can not set "base64":',e)}}var key,flashId=api.uid(),el=document.createElement("div"),attempts=10;for(key in opts)el.setAttribute(key,opts[key]),el[key]=opts[key];_css(el,opts),opts.width="100%",opts.height="100%",el.innerHTML=_makeFlashHTML(api.extend({id:flashId,src:_getUrl(api.flashImageUrl,"r="+api.uid()),wmode:"opaque",flashvars:"scale="+opts.scale+"&callback="+_wrap(function _(){return _unwrap(_),--attempts>0&&_setImage(),!0})},opts)),fn(!1,el),el=null}function _getFileDescr(file){return{id:file.id,name:file.name,matrix:file.matrix,flashId:file.flashId}}function _getDimensions(el){function getOffset(obj){var left,top;if(left=top=0,obj.offsetParent)do left+=obj.offsetLeft,top+=obj.offsetTop;while(obj=obj.offsetParent);return{left:left,top:top}}el.getBoundingClientRect(),document.body,(el&&el.ownerDocument).documentElement;return{top:getOffset(el).top,left:getOffset(el).left,width:el.offsetWidth,height:el.offsetHeight}}var _attr=api.uid(),_retry=0,_files={},_rhttp=/^https?:/i,flash={_fn:{},publish:function(el,id,opts){opts=opts||{},el.innerHTML=_makeFlashHTML({id:id,src:_getUrl(api.flashUrl,"r="+api.version),wmode:opts.camera?"":"transparent",flashvars:"callback="+(opts.onEvent||"FileAPI.Flash.onEvent")+"&flashId="+id+"&storeKey="+navigator.userAgent.match(/\d/gi).join("")+"_"+api.version+(flash.isReady||(api.pingUrl?"&ping="+api.pingUrl:""))+"&timeout="+api.flashAbortTimeout+(opts.camera?"&useCamera="+_getUrl(api.flashWebcamUrl):"")+"&debug="+(api.debug?"1":"")},opts)},init:function(){var child=document.body&&document.body.firstChild;if(child)do if(1==child.nodeType){api.log("FlashAPI.state: awaiting");var dummy=document.createElement("div");return dummy.id="_"+_attr,_css(dummy,{top:1,right:1,width:5,height:5,position:"absolute",zIndex:1e6+""}),child.parentNode.insertBefore(dummy,child),void flash.publish(dummy,_attr)}while(child=child.nextSibling);_retry<10&&setTimeout(flash.init,50*++_retry)},ready:function(){api.log("FlashAPI.state: ready"),flash.ready=api.F,flash.isReady=!0,flash.patch(),flash.patchCamera&&flash.patchCamera(),api.event.on(document,"mouseover",flash.mouseover),api.event.on(document,"click",function(evt){flash.mouseover(evt)&&(evt.preventDefault?evt.preventDefault():evt.returnValue=!0)})},getEl:function(){return document.getElementById("_"+_attr)},getWrapper:function(node){do if(/js-fileapi-wrapper/.test(node.className))return node;while((node=node.parentNode)&&node!==document.body)},disableMouseover:!1,mouseover:function(evt){if(!flash.disableMouseover){var target=api.event.fix(evt).target;if(/input/i.test(target.nodeName)&&"file"==target.type&&!target.disabled){var state=target.getAttribute(_attr),wrapper=flash.getWrapper(target);if(api.multiFlash){if("i"==state||"r"==state)return!1;if("p"!=state){target.setAttribute(_attr,"i");var dummy=document.createElement("div");if(!wrapper)return void api.log("[err] FlashAPI.mouseover: js-fileapi-wrapper not found");_css(dummy,{top:0,left:0,width:target.offsetWidth,height:target.offsetHeight,zIndex:1e6+"",position:"absolute"}),wrapper.appendChild(dummy),flash.publish(dummy,api.uid()),target.setAttribute(_attr,"p")}return!0}if(wrapper){var box=_getDimensions(wrapper);_css(flash.getEl(),box),flash.curInp=target}}else/object|embed/i.test(target.nodeName)||_css(flash.getEl(),{top:1,left:1,width:5,height:5})}},onEvent:function(evt){var type=evt.type;if("ready"==type){try{flash.getInput(evt.flashId).setAttribute(_attr,"r")}catch(e){}return flash.ready(),setTimeout(function(){flash.mouseenter(evt)},50),!0}"ping"===type?api.log("(flash -> js).ping:",[evt.status,evt.savedStatus],evt.error):"log"===type?api.log("(flash -> js).log:",evt.target):type in flash&&setTimeout(function(){api.log("FlashAPI.event."+evt.type+":",evt),flash[type](evt)},1)},mouseDown:function(evt){flash.disableMouseover=!0},cancel:function(evt){flash.disableMouseover=!1},mouseenter:function(evt){var node=flash.getInput(evt.flashId);if(node){flash.cmd(evt,"multiple",null!=node.getAttribute("multiple"));var accept=[],exts={};_each((node.getAttribute("accept")||"").split(/,\s*/),function(mime){api.accept[mime]&&_each(api.accept[mime].split(" "),function(ext){exts[ext]=1})}),_each(exts,function(i,ext){accept.push(ext)}),flash.cmd(evt,"accept",accept.length?accept.join(",")+","+accept.join(",").toUpperCase():"*")}},get:function(id){return document[id]||window[id]||document.embeds[id]},getInput:function(id){if(!api.multiFlash)return flash.curInp;try{var node=flash.getWrapper(flash.get(id));if(node)return node.getElementsByTagName("input")[0]}catch(e){api.log('[err] Can not find "input" by flashId:',id,e)}},select:function(evt){try{var event,inp=flash.getInput(evt.flashId),uid=api.uid(inp),files=evt.target.files;_each(files,function(file){api.checkFileObj(file)}),_files[uid]=files,document.createEvent?(event=document.createEvent("Event"),event.files=files,event.initEvent("change",!0,!0),inp.dispatchEvent(event)):jQuery?jQuery(inp).trigger({type:"change",files:files}):(event=document.createEventObject(),event.files=files,inp.fireEvent("onchange",event))}finally{flash.disableMouseover=!1}},interval:null,cmd:function(id,name,data,last){flash.uploadInProgress&&flash.readInProgress?setTimeout(function(){flash.cmd(id,name,data,last)},100):this.cmdFn(id,name,data,last)},cmdFn:function(id,name,data,last){try{return api.log("(js -> flash)."+name+":",data),flash.get(id.flashId||id).cmd(name,data)}catch(e){api.log("(js -> flash).onError:",e),last||setTimeout(function(){flash.cmd(id,name,data,!0)},50)}},patch:function(){api.flashEngine=!0,_inherit(api,{readAsDataURL:function(file,callback){_isHtmlFile(file)?this.parent.apply(this,arguments):(api.log("FlashAPI.readAsBase64"),flash.readInProgress=!0,flash.cmd(file,"readAsBase64",{id:file.id,callback:_wrap(function _(err,base64){flash.readInProgress=!1,_unwrap(_),api.log("FlashAPI.readAsBase64:",err),callback({type:err?"error":"load",error:err,result:"data:"+file.type+";base64,"+base64})})}))},readAsText:function(file,encoding,callback){callback?api.log("[warn] FlashAPI.readAsText not supported `encoding` param"):callback=encoding,api.readAsDataURL(file,function(evt){if("load"==evt.type)try{evt.result=window.atob(evt.result.split(";base64,")[1])}catch(err){evt.type="error",evt.error=err.toString()}callback(evt)})},getFiles:function(input,filter,callback){if(callback)return api.filterFiles(api.getFiles(input),filter,callback),null;var files=api.isArray(input)?input:_files[api.uid(input.target||input.srcElement||input)];return files?(filter&&(filter=api.getFilesFilter(filter),files=api.filter(files,function(file){return filter.test(file.name)})),files):this.parent.apply(this,arguments)},getInfo:function(file,fn){if(_isHtmlFile(file))this.parent.apply(this,arguments);else if(file.isShot)fn(null,file.info={width:file.width,height:file.height});else{if(!file.__info){var defer=file.__info=api.defer();defer.resolve(null,file.info=null)}file.__info.then(fn)}}}),api.support.transform=!0,api.Image&&_inherit(api.Image.prototype,{get:function(fn,scaleMode){return this.set({scaleMode:scaleMode||"noScale"}),this.parent(fn)},_load:function(file,fn){if(api.log("FlashAPI.Image._load:",file),_isHtmlFile(file))this.parent.apply(this,arguments);else{var _this=this;api.getInfo(file,function(err){fn.call(_this,err,file)})}},_apply:function(file,fn){if(api.log("FlashAPI.Image._apply:",file),_isHtmlFile(file))this.parent.apply(this,arguments);else{var m=this.getMatrix(file.info),doneFn=fn;flash.cmd(file,"imageTransform",{id:file.id,matrix:m,callback:_wrap(function _(err,base64){api.log("FlashAPI.Image._apply.callback:",err),_unwrap(_),err?doneFn(err):api.support.html5||api.support.dataURI&&!(base64.length>3e4)?(m.filter&&(doneFn=function(err,img){err?fn(err):api.Image.applyFilter(img,m.filter,function(){fn(err,this.canvas)})}),api.newImage("data:"+file.type+";base64,"+base64,doneFn)):_makeFlashImage({width:m.deg%180?m.dh:m.dw,height:m.deg%180?m.dw:m.dh,scale:m.scaleMode},base64,doneFn)})})}},toData:function(fn){var file=this.file,info=file.info,matrix=this.getMatrix(info);api.log("FlashAPI.Image.toData"),_isHtmlFile(file)?this.parent.apply(this,arguments):("auto"==matrix.deg&&(matrix.deg=api.Image.exifOrientation[info&&info.exif&&info.exif.Orientation]||0),fn.call(this,!file.info,{id:file.id,flashId:file.flashId,name:file.name,type:file.type,matrix:matrix}))}}),api.Image&&_inherit(api.Image,{fromDataURL:function(dataURL,size,callback){!api.support.dataURI||dataURL.length>3e4?_makeFlashImage(api.extend({scale:"exactFit"},size),dataURL.replace(/^data:[^,]+,/,""),function(err,el){callback(el)}):this.parent(dataURL,size,callback)}}),_inherit(api.Form.prototype,{toData:function(fn){for(var items=this.items,i=items.length;i--;)if(items[i].file&&_isHtmlFile(items[i].blob))return this.parent.apply(this,arguments);api.log("FlashAPI.Form.toData"),fn(items)}}),_inherit(api.XHR.prototype,{_send:function(options,formData){if(formData.nodeName||formData.append&&api.support.html5||api.isArray(formData)&&"string"==typeof formData[0])return this.parent.apply(this,arguments);var flashId,fileId,data={},files={},_this=this;if(_each(formData,function(item){item.file?(files[item.name]=item=_getFileDescr(item.blob),fileId=item.id,flashId=item.flashId):data[item.name]=item.blob}),fileId||(flashId=_attr),!flashId)return api.log("[err] FlashAPI._send: flashId -- undefined"),this.parent.apply(this,arguments);api.log("FlashAPI.XHR._send: "+flashId+" -> "+fileId),_this.xhr={headers:{},abort:function(){flash.uploadInProgress=!1,flash.cmd(flashId,"abort",{id:fileId})},getResponseHeader:function(name){return this.headers[name]},getAllResponseHeaders:function(){return this.headers}};var queue=api.queue(function(){flash.uploadInProgress=!0,flash.cmd(flashId,"upload",{url:_getUrl(options.url.replace(/([a-z]+)=(\?)&?/i,"")),data:data,files:fileId?files:null,headers:options.headers||{},callback:_wrap(function upload(evt){var type=evt.type,result=evt.result;api.log("FlashAPI.upload."+type),"progress"==type?(evt.loaded=Math.min(evt.loaded,evt.total),evt.lengthComputable=!0,options.progress(evt)):"complete"==type?(flash.uploadInProgress=!1,_unwrap(upload),"string"==typeof result&&(_this.responseText=result.replace(/%22/g,'"').replace(/%5c/g,"\\").replace(/%26/g,"&").replace(/%25/g,"%")),_this.end(evt.status||200)):"abort"!=type&&"error"!=type||(flash.uploadInProgress=!1,_this.end(evt.status||0,evt.message),_unwrap(upload))})})});_each(files,function(file){queue.inc(),api.getInfo(file,queue.next)}),queue.check()}})}};api.Flash=flash,api.newImage("data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",function(err,img){api.support.dataURI=!(1!=img.width||1!=img.height),flash.init()})}()}(window,window.jQuery,FileAPI),function(window,jQuery,api){"use strict";var _each=api.each,_cameraQueue=[];api.support.flash&&api.media&&!api.support.media&&!function(){function _wrap(fn){var id=fn.wid=api.uid();return api.Flash._fn[id]=fn,"FileAPI.Flash._fn."+id}function _unwrap(fn){try{api.Flash._fn[fn.wid]=null,delete api.Flash._fn[fn.wid]}catch(e){}}var flash=api.Flash;api.extend(api.Flash,{patchCamera:function(){api.Camera.fallback=function(el,options,callback){var camId=api.uid();api.log("FlashAPI.Camera.publish: "+camId),flash.publish(el,camId,api.extend(options,{camera:!0,onEvent:_wrap(function _(evt){"camera"===evt.type&&(_unwrap(_),evt.error?(api.log("FlashAPI.Camera.publish.error: "+evt.error),callback(evt.error)):(api.log("FlashAPI.Camera.publish.success: "+camId),callback(null)))})}))},_each(_cameraQueue,function(args){api.Camera.fallback.apply(api.Camera,args)}),_cameraQueue=[],api.extend(api.Camera.prototype,{_id:function(){return this.video.id},start:function(callback){var _this=this;flash.cmd(this._id(),"camera.on",{callback:_wrap(function _(evt){_unwrap(_),evt.error?(api.log("FlashAPI.camera.on.error: "+evt.error),callback(evt.error,_this)):(api.log("FlashAPI.camera.on.success: "+_this._id()),_this._active=!0,callback(null,_this))})})},stop:function(){this._active=!1,flash.cmd(this._id(),"camera.off")},shot:function(){api.log("FlashAPI.Camera.shot:",this._id());var shot=api.Flash.cmd(this._id(),"shot",{});return shot.type="image/png",shot.flashId=this._id(),shot.isShot=!0,new api.Camera.Shot(shot)}})}}),api.Camera.fallback=function(){_cameraQueue.push(arguments)}}()}(window,window.jQuery,FileAPI),"function"==typeof define&&define.amd&&define("FileAPI",[],function(){return FileAPI});