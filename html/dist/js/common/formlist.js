define(["app","jquery","./moduls/directive"],function(app,$){app.directive("formList",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"../template/common/formlist.html",scope:{data:"=data",edit:"=edit",filter:"=filter",searchform:"=searchform",page:"=page"},controller:function($scope,$state,$element,$rootScope){layui.link("js/plug/layui/css/layui.css");var icon={add:"plus",edit:"pencil",down:"download-alt",upload:"upload-alt",zoom_in:"zoom-in",del:"trash"};$scope.$watch(function(){return $scope.data},function(){if($scope.data)return $.each($scope.data.table.edit,function(i,obj){obj.icon=icon[obj.cls]}),void($scope.data.table.edit1&&$.each($scope.data.table.edit1,function(i,obj){obj.icon=icon[obj.cls]}))},!0)},link:function($scope,element,arrt,controller){function check(select,callback){select.each(function(){var input=$(this).find("input");input.unbind().click(function(e){e.stopPropagation(),callback(this.checked)}),$(this).click(function(){input.click()})})}var thSelect,len,selectIcon,ele=$(element[0]),index=0;$scope.isSelectAll=!1,$scope.selectAllIcon=!1,$scope.$watch("isSelectAll",function(){thSelect&&select&&(1==$scope.isSelectAll?($scope.selectAllIcon=!0,index=len):0==$scope.isSelectAll?($scope.selectAllIcon=!1,index=0):$scope.selectAllIcon=!1,select.children().each(function(){!0===$scope.isSelectAll?this.checked=!0:0==$scope.isSelectAll&&(this.checked=!1)}))}),$scope.$watch("selectAllIcon",function(){thSelect&&select&&($scope.selectAllIcon?(thSelect.children()[0].checked=!0,selectIcon&&(selectIcon.className="icon-ok-sign")):(thSelect.children()[0].checked=!1,selectIcon&&(selectIcon.className="icon-ok")))}),angular.extend($scope,{thFinish:function(){$scope.data.table.select&&(thSelect=ele.find("th.select"),check(thSelect,function(checked){$scope.selectEdit()}))},tdFinish:function(){$scope.data.table.select&&(select=ele.find("td.select"),len=select.length,check(select,function(checked){checked?index++:index--,$scope.isSelectAll=index>=len||!(index<=0)&&2,$scope.$apply()}))},editsFinish:function(){$.each($scope.data.table.edit,function(i,obj){obj.cls})},submit:function(callback,obj,$event){callback&&callback(obj,$scope,$event)}}),$scope.selectEdit=function(){$scope.isSelectAll=!0!==$scope.isSelectAll,"$apply"!=$scope.$root.$$phase&&"$digest"!=$scope.$root.$$phase&&$scope.$apply()},$scope.selectAll=function(evt){selectIcon=$(evt.currentTarget).find("i")[0],$scope.selectEdit()},$scope.getSelect=$scope.delAll=function(callback){var arr="";select.children().each(function(){1==this.checked&&(arr+=$(this).parent().parent().attr("data-id")+",")}),arr=arr.substr(0,arr.length-1),arr.length<1?layui.use(["layer"],function(){layui.layer.msg("请至少选择一项进行操作。",function(){})}):callback(arr)},$scope.getOneSelect=function(callback){$scope.getSelect(function(str){str.split(",").length>1?layui.use(["layer"],function(){layui.layer.msg("暂时不支持多个选择。",function(){})}):callback(str)})},$scope.current=1,$scope.$watch(function(){return $scope.page},function(){if($scope.page&&$scope.page.pageCount)return layui.use(["laypage","layer"],function(){var laypage=layui.laypage;layui.layer;laypage({cont:"pages",pages:$scope.page.pageCount,groups:5,curr:$scope.page.page,jump:function(obj){$scope.current=obj.curr,$scope.page.jump(obj)}})}),!1},!0)}}})});