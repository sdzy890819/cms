define(["app","require","jquery","./moduls/directive"],function(e,t,i){layui.link("js/plug/layui/css/layui.css"),e.directive("formHorizontal",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"../template/common/form.html",scope:{formdata:"=formdata",edit:"=edit",titelement:"=titelement",data:"=data"},controller:function(e,t,n,a,c,l,s){var o={add:"plus",save:"save",view:"eye-open",del:"trash",upload:"upload-alt",magnet:"magnet",ok:"ok",cancel:"minus-sign"};e.$css=l,e.$uibModal=c,angular.extend(e,{isArray:function(e){return angular.isArray(e)},selectDate:function(e){layui.laydate({elem:e.target,istime:!0,format:"YYYY-MM-DD hh:mm:ss",festival:!0})},close:function(){e.$parent.close()},submit:function(e,t,i){e(t,i.target)},inputNum:1,addInput:function(t,n){var a,c,l=e.inputNum+1;if(name=t.name.match(/\d+$/),title=t.title.replace(t.title.match(/\d+$/)[0],""),i.each(e.formdata.list,function(t,i){i.num==e.inputNum&&(a=e.formdata.list.slice(0,t+1),c=e.formdata.list.slice(t+1))}),e.inputNum<t.inputMaxNum)return name?name=t.name.replace(name[0],""):name=t.name,t.name=name+t.num,a.push({title:title+l,name:name+l,placeholder:"请输入扩展字段内容",num:l,inputMaxNum:t.inputMaxNum,type:t.type}),e.formdata.list=a.concat(c),void("$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply());layui.use("layer",function(){layui.layer.msg("扩展字段只能添加"+(l-1)+"条",{icon:2,anim:6})})},delInput:function(t,n){var a=e.formdata.list.slice(0,n+1),c=e.formdata.list.slice(n+1),l=t.name.match(/\d+$/),s=t.title.replace(t.title.match(/\d+$/)[0],"");t.num;l=l?t.name.replace(l[0],""):t.name,a.pop(),i.each(c,function(e,t){this.inputMaxNum&&(this.num--,this.title=s+this.num,this.name=l+this.num)}),e.formdata.list=a.concat(c),"$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply()},selectSizes:[],selectSize:function(t,n){var a=n.target,c=i(a);if(void 0==a.isclick&&(a.isclick=!1),a.isclick=!a.isclick,a.isclick)c.addClass("cur"),e.selectSizes.push(t);else{var l=[];i.each(e.selectSizes,function(e,i){t.id!=i.id&&l.push(i)}),e.selectSizes=l,c.removeClass("cur")}},selectSizeRights:[],selectSizeRight:function(t,n){var a=n.target,c=i(a);if(void 0==a.isclick&&(a.isclick=!1),a.isclick=!a.isclick,a.isclick)c.addClass("cur"),e.selectSizeRights.push(t);else{var l=[];i.each(e.selectSizeRights,function(e,i){t.id!=i.id&&l.push(i)}),e.selectSizeRights=l,c.removeClass("cur")}},addSelectSize:function(t,n,a){function c(n){if(n.title==t.title){if(1==a){var c=!0,l=[];(s=e.selectSizes.slice(0)).length&&(i.each(n.fromSelect,function(e,t){c=!0;for(var i=0;i<s.length;i++)if(s[i].id==t.id){c=!1;break}1==c&&l.push(t)}),t.fromSelect=l,e.selectSizes=[]),n.toSelect=n.toSelect.concat(s)}else{var s=e.selectSizeRights.slice(0),c=!0,l=[];s.length&&(i.each(n.toSelect,function(e,t){c=!0;for(var i=0;i<s.length;i++)if(s[i].id==t.id){c=!1;break}1==c&&l.push(t)}),t.toSelect=l,e.selectSizeRights=[]),n.fromSelect=n.fromSelect.concat(s)}e.selectSizeChoose=n.toSelect}}i.each(e.formdata.list,function(e,t){"array"==i.type(t)?i.each(t,function(e,t){c(t)}):c(t)})}}),e.$watch(function(){return e.formdata},function(){if(e.formdata){i.each(e.formdata.submit,function(){this.icon_cls=o[this.icon_cls]});var t=0;return i.each(e.formdata.list,function(){"edit"==this.type||this.inputMaxNum&&t++}),void(e.inputNum=t)}},!0)},link:function(e,t,n,a){i(t[0]);e.selects=[],e.checkboxs=[],layui.use(["form","layedit","laydate"],function(){var t=layui.form();layui.layer,layui.layedit,layui.laydate;angular.extend(e,{formRepeat:function(){function n(){var e=this;if("date"==this.type)layui.use("laydate",function(){});else if("file"==this.type);else if("upload"==this.type)layui.use("upload",function(){e.callback&&e.callback(layui)});else if("edit"==this.type){var t=i(".wangEditor").attr("data-html");!function e(){window.Editor?window.Editor.$txt.html(t):setTimeout(e,100)}()}}function a(n){var a=this;i.each(a.select,function(c,l){if(l[0].title==n.elem.name){var s=l[n.elem.selectedIndex];if(s.title=n.elem.name,e.selects.length){var o=!1;i.each(e.selects,function(t,i){n.elem.name;i.title==n.elem.name&&(o=!0,e.selects[t]=s)}),o||e.selects.push(s)}else e.selects.push(s);if(s.name.indexOf("请选择")>-1)return;a.callback&&a.callback({obj:s,index:n.elem.selectedIndex,title:n.elem.name,name:n.name,callback:function(){t.render()}})}})}i.each(e.formdata.list,function(e,t){"array"==i.type(t)?i.each(t,function(){n.call(this)}):n.call(this)}),t.render(),t.verify({useless:function(e){},title:function(e){if(e.length<1)return"请填写所有必填项!"},userName:function(e){if(e.length<5)return"用户名至少为5个字符串"},password:function(e){if(e.length<6)return"密码至少为6个字符串"},image:function(e){if(e.length<1)return"请上传图片"},imageTitle:function(e){if(e.length<1)return"请填写图片标题"},http:function(e){var t=/^(http|https):\/\/([\w-]+\.)+[\w-]+(\/[\w-./?%&=]*)?$/;if(e.search(t)<0)return"请输入正确的域名（例：http://www.xy.com）"},path:function(e){var t=/[\s,，.。\|\*\#]/;if(null!=e.match(t)||""==e)return"请输入正确的路经（例：xy/xy）"},select:function(e,t){if(e.indexOf("请选择")>-1&&0==t.parentNode.selectedIndex)return e},html:function(e){var t=/^\w+\.html/;if(e.search(t)<0)return"请输入正确文件名（例：index.html）"},channelPath:function(e){if(e.length<1)return"请输入绝对路径"}}),t.on("submit(demo1)",function(t){var n=i(t.elem).attr("data-event");try{var a=window.top.document.getElementById("editor").contentWindow.getContent();t.field.html=a}catch(e){}return t.field.selects=e.selects,t.field.checkboxs=e.checkboxs,t.field.selectSizeChoose=e.selectSizeChoose,e.$parent[n](t.field),!1}),t.on("select",function(t){i.each(e.formdata.list,function(e,n){"array"==i.type(n)?i.each(n,function(){"select"==this.type&&a.call(this,t)}):"select"==this.type&&a.call(this,t)})}),t.on("checkbox",function(t){var n,a=parseInt(i(t.elem).attr("data-index"));i.each(e.formdata.list,function(c,l){if("checkbox"==this.type)if(t.elem.checked)(n=l.checkbox[a])._index=a,e.checkboxs.push(n);else{var s=[];i.each(e.checkboxs,function(e,t){t._index!=a&&s.push(t)}),e.checkboxs=s}})})},selectRpeatDone:function(){setTimeout(function(){t.render("select");var e=i(".hide-select");e.length&&(e.find(".layui-form-select").remove(),e.find("select").show())},100)},checkboxRpeatDone:function(){setTimeout(function(){t.render("checkbox")},100)},radioRpeatDone:function(){setTimeout(function(){t.render("radio")},100)}})})}}})});