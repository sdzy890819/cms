define(["app","./addForm","../upload/index","../data/getData","form","position","fixedNav"],function(app,list,upload,getData){app.directive("imageAdd",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"../template/common/addAndEdit.html",controller:function($scope,Upload,$uibModal,$state){$scope.title="新增图片",$scope.$parent.menu.push({name:$scope.title}),$scope.data={imageWidth:360},angular.extend($scope,{save:function(obj){function alert(content){layui.use(["layer"],function(){layui.layer.msg(content,{icon:5})})}var imagesClassifyId,watermark="yes"==obj.watermark?1:0,isSize=obj.isSize,selectSize=obj.selectSize,width=obj.imageWidth,height=obj.imageHeight,keyword=obj.keyword,title=obj.title;if($.each(obj.selects,function(){"imagesClassifyId"==this.title&&(imagesClassifyId=this.id)}),height>0&&(width=0),width>0&&(height=0),watermark="no"==isSize?0:1,!$scope.imageInfo)return alert("请上传图片!");var suffix=$scope.imageInfo.name.match(/\w+$/)[0];Upload.base64DataUrl($scope.imageInfo).then(function(urls){urls&&("no"==isSize||"yes"==isSize&&"yes"==selectSize&&width||"yes"==isSize&&"no"==selectSize&&height)?getData.upload.uploadImage({baseCode:urls.split(",")[1],suffix:suffix,watermark:watermark,width:width,height:height,callback:function(_data){var data=_data.data;getData.image.createImages({imageUrl:data.imageUrl,imageWidthPixel:data.imageWidthPixel,imageHeightPixel:data.imageHeightPixel,orgWidthPixel:data.orgWidthPixel,orgHeightPixel:data.orgHeightPixel,imageTitle:title,keyword:keyword,imagesClassifyId:imagesClassifyId,imagePath:data.imagePath,watermark:data.watermark,compress:data.compress,fid:data.fid,size:data.size,callback:function(_data){layui.use(["layer"],function(){layui.layer.msg(_data.message),0==_data.code&&$state.go("image.list")})}})}}):urls?"yes"!=isSize||"yes"!=selectSize||width?"yes"!=isSize||"no"!=selectSize||height||alert("请输入高度"):alert("请输入宽度"):alert("请上传图片")})}}),$scope.$on("formRepeat",function(){$(".layui-upload-button").unbind().click(function(){upload.init({data:{obj:{},title:"上传图片",name:"请选择图片",type:"image",event:function(file,$uibModalInstance){$scope.imageInfo=file,Upload.base64DataUrl($scope.imageInfo).then(function(urls){var image="<img src='"+file.$ngfDataUrl+"'width='100px' class='thumb'>";$(".imagePre").empty().append(image)}),$uibModalInstance.dismiss("cancel")}},$uibModal:$uibModal})});var form=$("form.layui-form"),selectSize=(form.find('input[name="isSize"]'),form.find('input[name="selectSize"]')),selectSize_parent=selectSize.parent().parent(),width=form.find('input[name="imageWidth"]'),width_parent=width.parent().parent(),height=form.find('input[name="imageHeight"]'),height_parent=height.parent().parent(),iswidth=!0;width_parent.hide(),height_parent.hide(),selectSize_parent.hide(),layui.use(["form","layedit","laydate"],function(){function setWidthAndHeightInput(){0==iswidth?(height_parent.show(),width_parent.hide(),width.val("")):(height_parent.hide(),width_parent.show(),height.val(""))}var form=layui.form();layui.layer,layui.layedit,layui.laydate;form.on("radio",function(_obj){var name=_obj.elem.name,value=_obj.value;"isSize"==name?"no"==value?(selectSize_parent.hide(),width_parent.hide(),height_parent.hide(),width.val("0"),height.val("0")):(selectSize_parent.show(),setWidthAndHeightInput()):"selectSize"==name&&(iswidth="no"!=value,setWidthAndHeightInput())})})}),list(function(data){$scope.formdata={title:$scope.title,list:data,submit:[{name:"保存",evt:"save",icon_cls:"save"},{name:"取消",evt:"cancel",icon_cls:"cancel",cls:"cancel"}]}})}}})});