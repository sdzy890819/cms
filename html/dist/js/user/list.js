define(["require","app","jquery","../data/getData","./addForm","search","./searchForm","../common/editPop","../upload/index","formlist","position","fixedNav","../moduls/service","../moduls/factory"],function(require,app,$,getData,list,search,searchForm,editPop,upload){app.directive("userList",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"../template/common/list.html",controller:function($scope,pop,$uibModal,$css,GenerateArrList,Upload){function setList(_data){var th=[{name:"头像",key:"headImage",width:"200"},{name:"真实名称",key:"realName"},{name:"用户名",key:"userName"},{name:"IDFA(MAC)",key:"idfa"},{name:"用户ID",key:"userId"},{name:"创建人",key:"createUserName",width:60},{name:"创建时间",key:"createTimeStr",width:80},{name:"修改人",key:"lastModifyUserName",width:60},{name:"修改时间",key:"updateTimeStr",width:80},{name:"操作",width:"300",class:"center"}];$.each(_data.data.list,function(i,a){a.idfa||(a.idfa="")}),$scope.listdata={title:$scope.title,table:{select:!0,th:th,td:GenerateArrList.setArr(_data.data.list,th),edit:[{cls:"edit",name:"所属频道",evt:$scope.editUserChannel},{cls:"edit",name:"用户组",evt:$scope.editUserPosition},{cls:"edit",name:"编辑",evt:$scope.edit},{cls:"del",name:"删除",evt:$scope.del}]}},GenerateArrList.changeTypeName($scope.listdata.table.td,[{name:"headImage",newName:"image"}]),$.each($scope.listdata.table.td,function(i,obj){obj.list[0].image=obj.headImage,obj.list[0].name=!1}),GenerateArrList.extendChild($scope.listdata.table.td,$scope.listdata.table.edit,"edit"),$scope.$apply()}function getDataList(){getData.user.userlist({page:page,pageSize:20,callback:function(_data){$scope.page=_data.data.page,$scope.page.jump=function(obj){page!=obj.curr&&(page=obj.curr,getDataList())},setList(_data)}})}$scope.title="用户列表",$scope.$parent.menu.push({name:$scope.title}),$.extend($scope,{add:function(id){pop.alert({text:"你的ID为："+id,btn:["确定","取消"],fn:function(index){layer.close(index)}})},editUserChannel:function(obj){require(["./channelPop"],function(pop){pop.init({obj:obj,$uibModal:$uibModal})})},editUserPosition:function(obj){require(["./positionPop"],function(pop){pop.init({obj:obj,$uibModal:$uibModal})})},edit:function(obj){function getAddForm(callback,formList){getData.user.detail({userId:obj.userId,callback:function(_data){_data.pwd="",_data.userName=obj.userName,formList||callback(_data)}})}var imageInfo=null;editPop.init({obj:obj,list:list,updateData:getAddForm,save:function(obj,_detail){getData.user.updateUser2({userId:_detail.userId,userName:obj.userName,realName:obj.realName,pwd:obj.pwd,headImage:imageInfo?imageInfo.imageUrl:_detail.headImage,idfa:obj.idfa,callback:function(_data){layui.use(["layer"],function(){layui.layer.msg(_data.message),getDataList()})}})},callback:function(list,callback){callback(list),$.each(list,function(i,obj){"password"==obj.type&&(obj.verify=null)}),setTimeout(function(){$(".layui-upload-button").unbind().click(function(){upload.init({data:{obj:{},title:"上传图片",name:"请选择图片",type:"image",event:function(file,$uibModalInstance){function alert(content){layui.use(["layer"],function(){layui.layer.msg(content,{icon:5})})}$scope.imageInfo=file;var suffix=$scope.imageInfo.name.match(/\w+$/)[0];Upload.base64DataUrl($scope.imageInfo).then(function(urls){var image="<img src='"+file.$ngfDataUrl+"'width='100px' class='thumb'>";$(".imagePre").empty().append(image),urls?getData.upload.uploadImage({baseCode:urls.split(",")[1],suffix:suffix,width:100,callback:function(_data){imageInfo=_data.data,alert(_data.message)}}):urls?"yes"!=isSize||"yes"!=selectSize||width?"yes"!=isSize||"no"!=selectSize||height||alert("请输入高度"):alert("请输入高度"):alert("请上传图片")}),$uibModalInstance.dismiss("cancel")}},$uibModal:$uibModal})})},300)},$uibModal:$uibModal})},del:function(obj){pop.alert({text:"你确定删除："+obj.realName,btn:["确定","取消"],fn:function(index){getData.user.delUser(obj)}}),obj.callback=function(_data){layui.use(["layer"],function(){layui.layer.msg(_data.message),0==_data.code&&$("table").find("tr[data-id="+obj.id+"]").hide()})}},filter:["id","userId","lastModifyUserId"],changeTypeName:[{name:"headImage",newName:"image"}]});var page=1;getDataList(),function(){var searchPage=1;searchForm(function(data){$scope.searchform={list:data,return:function(){getDataList(),$scope.searchform.search=null,page=1,searchPage=1,$scope.$$childHead.current=1},submit:function(obj,data){function getSearchList(){getData.search.searchUser({condition:obj.condition,page:searchPage,pageSize:20,callback:function(_data){$scope.page=_data.data.page,$scope.page.jump=function(obj){searchPage!=obj.curr&&(searchPage=obj.curr,getSearchList())},$scope.searchform.search={count:_data.data.page.count,name:obj.condition},void 0==_data.data.list&&(_data.data.list=[]),setList(_data)}})}getSearchList()}},$scope.$$phase||$scope.$apply()})}()},link:function($scope,element){}}})});