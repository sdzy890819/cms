define(["require","app","jquery","../data/getData","./addForm","search","./searchForm","../common/editPop","../upload/index","formlist","position","fixedNav","../moduls/service","../moduls/factory"],function(e,a,t,i,n,l,c,d,r){a.directive("userList",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"../template/common/list.html",controller:function(a,l,s,u,o,m){function f(e){var i=[{name:"头像",key:"headImage",width:"50"},{name:"真实名称",key:"realName"},{name:"用户名",key:"userName"},{name:"IDFA(MAC)",key:"idfa"},{name:"用户ID",key:"userId"},{name:"创建人",key:"createUserName",width:60},{name:"创建时间",key:"createTimeStr",width:80},{name:"修改人",key:"lastModifyUserName",width:60},{name:"修改时间",key:"updateTimeStr",width:80},{name:"操作",width:"100",class:"center"}];t.each(e.data.list,function(e,a){a.idfa||(a.idfa="")}),a.listdata={title:a.title,table:{select:!0,th:i,td:o.setArr(e.data.list,i),edit:[{cls:"edit",name:"所属频道",evt:a.editUserChannel},{cls:"edit",name:"用户组",evt:a.editUserPosition},{cls:"edit",name:"编辑",evt:a.edit},{cls:"del",name:"删除",evt:a.del}]}},o.changeTypeName(a.listdata.table.td,[{name:"headImage",newName:"image"}]),t.each(a.listdata.table.td,function(e,a){a.list[0].image=a.headImage,a.list[0].name=!1}),o.extendChild(a.listdata.table.td,a.listdata.table.edit,"edit"),a.$apply()}function p(){i.user.userlist({page:h,pageSize:20,callback:function(e){a.page=e.data.page,a.page.jump=function(e){h!=e.curr&&(h=e.curr,p())},f(e)}})}a.title="用户列表",a.$parent.menu.push({name:a.title}),t.extend(a,{add:function(e){l.alert({text:"你的ID为："+e,btn:["确定","取消"],fn:function(e){layer.close(e)}})},editUserChannel:function(a){e(["./channelPop"],function(e){e.init({obj:a,$uibModal:s})})},editUserPosition:function(a){e(["./positionPop"],function(e){e.init({obj:a,$uibModal:s})})},edit:function(e){var l=null;d.init({obj:e,list:n,updateData:function(a,t){i.user.detail({userId:e.userId,callback:function(i){i.pwd="",i.userName=e.userName,t||a(i)}})},save:function(e,a){i.user.updateUser2({userId:a.userId,userName:e.userName,realName:e.realName,pwd:e.pwd,headImage:l?l.imageUrl:a.headImage,idfa:e.idfa,callback:function(e){layui.use(["layer"],function(){layui.layer.msg(e.message),p()})}})},callback:function(e,n){function c(){var e=t(".layui-form-checkbox").parent().parent();e.length?e.remove():setTimeout(c,1e3/60)}n(e),t.each(e,function(e,a){"password"==a.type&&(a.verify=null)}),c(),setTimeout(function(){t(".layui-upload-button").unbind().click(function(){r.init({data:{obj:{},title:"上传图片",name:"请选择图片",type:"image",event:function(e,n){function c(e){layui.use(["layer"],function(){layui.layer.msg(e,{icon:5})})}a.imageInfo=e;var d=a.imageInfo.name.match(/\w+$/)[0];m.base64DataUrl(a.imageInfo).then(function(a){var n="<img src='"+e.$ngfDataUrl+"'width='100px' class='thumb'>";t(".imagePre").empty().append(n),a?i.upload.uploadImage({baseCode:a.split(",")[1],suffix:d,width:100,callback:function(e){l=e.data,c(e.message)}}):a?"yes"!=isSize||"yes"!=selectSize||width?"yes"!=isSize||"no"!=selectSize||height||c("请输入高度"):c("请输入高度"):c("请上传图片")}),n.dismiss("cancel")}},$uibModal:s})})},300)},$uibModal:s})},del:function(e){l.alert({text:"你确定删除："+e.realName,btn:["确定","取消"],fn:function(a){i.user.delUser(e)}}),e.callback=function(a){layui.use(["layer"],function(){layui.layer.msg(a.message),0==a.code&&t("table").find("tr[data-id="+e.id+"]").hide()})}},filter:["id","userId","lastModifyUserId"],changeTypeName:[{name:"headImage",newName:"image"}]});var h=1;p(),function(){var e=1;c(function(t){a.searchform={list:t,return:function(){a.searchform.search=null,h=1,e=1,a.$$childHead.current=1,p()},submit:function(t,n){function l(){i.search.searchUser({condition:t.condition,page:e,pageSize:20,callback:function(i){a.page=i.data.page,a.page.jump=function(a){e!=a.curr&&(e=a.curr,l())},a.searchform.search={count:i.data.page.count,name:t.condition},void 0==i.data.list&&(i.data.list=[]),f(i)}})}l()}},a.$$phase||a.$apply()})}()},link:function(e,a){}}})});