define(["require","app","jquery","search","./searchForm","./columnForm","../data/getData","../common/editPop","formlist","position","fixedNav","../moduls/service","../moduls/factory"],function(e,t,a,n,i,l,c,s){t.directive("newscolumnList",function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"../template/common/list.html",controller:function(t,n,d,u,o){function r(e){var n=[{name:"ID",key:"id",width:"50"},{name:"栏目名",key:"columnName"},{name:"频道ID",key:"channelId",width:"50"},{name:"频道名称",key:"channelName"},{name:"创建人",key:"createUserName",width:60},{name:"创建时间",key:"createTimeStr",width:80},{name:"修改人",key:"lastModifyUserName",width:60},{name:"修改时间",key:"updateTimeStr",width:80},{name:"操作",width:150,class:"center"}];t.listdata={title:t.title,table:{select:!0,th:n,td:d.setArr(e.data.list,n),edit:[{cls:"edit",name:"编辑",evt:t.edit},{cls:"edit",name:"对应模版",evt:t.template},{cls:"edit",name:"发布",evt:t.publish},{cls:"del",name:"删除",evt:t.del}]}},a.each(t.listdata.table.td,function(e,t){t.listUrl&&(t.list[1].href=t.listUrl)}),d.extendChild(t.listdata.table.td,t.listdata.table.edit,"edit"),t.$apply()}function m(){t.isSearch=!1,c.news.newscolumn_list({page:f,pageSize:20,callback:function(e){t.page=e.data.page,t.page.jump=function(e){f!=e.curr&&(f=e.curr,m())},r(e)}})}t.title="新闻栏目列表",t.$parent.menu.push({name:t.title}),angular.extend(t,{edit:function(e){var t=null;s.init({obj:e,list:l,updateData:function(a){c.news.newscolumn({id:e.id,callback:function(e){a(e),t=e}})},save:function(e,t){var n=t.channelId,i=t.listTemplate2Id,l=t.detailTemplate2Id;a.each(e.selects,function(){"channelId"==this.title&&(n=this.id),"listTemplate2Id"==this.title&&(i=this.id),"detailTemplate2Id"==this.title&&(l=this.id)}),c.news.updateNewsColumn({id:t.id,channelId:n,columnName:e.columnName,listId:e.listId,detailId:e.detailId,listTemplate2Id:i,detailTemplate2Id:l,keywords:e.keywords,description:e.description,path:e.path,fileName:e.fileName,publishUrl:e.publishUrl,callback:function(e){layui.use(["layer"],function(){layui.layer.msg(e.message),m()})}})},callback:function(e,t){t(e)},$uibModal:u})},del:function(e){e.callback=function(t){layui.use(["layer"],function(){layui.layer.msg(t.message),0==t.code&&a("table").find("tr[data-id="+e.id+"]").hide()})},n.alert({text:'您确定要删除"'+e.columnName+'"吗',btn:["确定","取消"],fn:function(){c.news.delNewsColumn(e)}})},template:function(t){e(["../common/editPopList"],function(e){function i(e){e.relationType=1,e.relationId=e.channelId,e.templateId=e.id,e.callback=function(t){layui.use(["layer"],function(){layui.layer.msg(t.message),0==t.code&&a("table").find("tr[data-id="+e.id+"]").hide()})},n.alert({text:'您确定要删除"'+e.templateName+'"吗',btn:["确定","取消"],fn:function(){c.template.delRelationByColumnList(e)}})}t.size="sm",e.init({obj:null,list:function(e){c.template.listTemplateBycolumnId({columnId:t.id,callback:function(t){var n=[{name:"模板标题",key:"templateName"},{name:"模版类型",key:"templateClassifyStr",width:100},{name:"操作",class:"center"}],l={title:"对应模版",table:{th:n,td:d.setArr(t.data,n),edit:[{cls:"del",name:"删除",evt:i}]}};d.extendChild(l.table.td,l.table.edit,"edit"),a.each(l.table.td,function(e,t){t.publish&&(null!=t.publishUrl?t.list[1].href=t.publishUrl:t.list[1].href="/webapi/template/redirect/"+t.id)}),e(t,l)}})},$uibModal:u})})},publish:function(e){e.callback=function(e){layui.use(["layer"],function(){layui.layer.msg(e.message)})},n.alert({text:"您确认要发布当前栏目下的所有新闻页吗?",btn:["确定","取消"],fn:function(){e.columnPublishInfo&&0!=e.columnPublishInfo.state?n.alert({text:e.columnPublishInfo.message,btn:["确定"]}):c.news.newscolumn_publish(e)}})}}),i(function(e){t.searchform={list:e,return:function(){t.searchform.search=null,f=1,searchPage=1,t.$$childHead.current=1,m()},submit:function(e,n){function i(){c.news.newscolumn_list({channelId:l,page:s,pageSize:20,callback:function(a){t.page=a.data.page,t.page.jump=function(e){s!=e.curr&&(s=e.curr,i())},t.searchform.search={count:a.data.page.count,name:e.condition},r(a)}})}t.isSearch=!0;var l,s=1;a.each(e.selects,function(){"channelId"==this.title&&(l=this.id)}),i(),t.getSearchList=i}},setTimeout(function(){var e=a('.layui-form input[name="condition"');a("<br>").insertBefore(e.parent().parent())},300)});var f=1;m()},link:function(e,t){}}})});