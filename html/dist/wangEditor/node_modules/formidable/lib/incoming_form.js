function IncomingForm(opts){return this instanceof IncomingForm?(EventEmitter.call(this),opts=opts||{},this.error=null,this.ended=!1,this.maxFields=opts.maxFields||1e3,this.maxFieldsSize=opts.maxFieldsSize||2097152,this.keepExtensions=opts.keepExtensions||!1,this.uploadDir=opts.uploadDir||os.tmpDir(),this.encoding=opts.encoding||"utf-8",this.headers=null,this.type=null,this.hash=opts.hash||!1,this.multiples=opts.multiples||!1,this.bytesReceived=null,this.bytesExpected=null,this._parser=null,this._flushing=0,this._fieldsSize=0,this.openedFiles=[],this):new IncomingForm(opts)}function dummyParser(self){return{end:function(){return self.ended=!0,self._maybeEnd(),null}}}global.GENTLY&&(require=GENTLY.hijack(require));var crypto=require("crypto"),fs=require("fs"),util=require("util"),path=require("path"),File=require("./file"),MultipartParser=require("./multipart_parser").MultipartParser,QuerystringParser=require("./querystring_parser").QuerystringParser,OctetParser=require("./octet_parser").OctetParser,JSONParser=require("./json_parser").JSONParser,StringDecoder=require("string_decoder").StringDecoder,EventEmitter=require("events").EventEmitter,Stream=require("stream").Stream,os=require("os");util.inherits(IncomingForm,EventEmitter),exports.IncomingForm=IncomingForm,IncomingForm.prototype.parse=function(req,cb){if(this.pause=function(){try{req.pause()}catch(err){return this.ended||this._error(err),!1}return!0},this.resume=function(){try{req.resume()}catch(err){return this.ended||this._error(err),!1}return!0},cb){var fields={},files={};this.on("field",function(name,value){fields[name]=value}).on("file",function(name,file){this.multiples&&files[name]?(Array.isArray(files[name])||(files[name]=[files[name]]),files[name].push(file)):files[name]=file}).on("error",function(err){cb(err,fields,files)}).on("end",function(){cb(null,fields,files)})}this.writeHeaders(req.headers);var self=this;return req.on("error",function(err){self._error(err)}).on("aborted",function(){self.emit("aborted"),self._error(new Error("Request aborted"))}).on("data",function(buffer){self.write(buffer)}).on("end",function(){if(!self.error){var err=self._parser.end();err&&self._error(err)}}),this},IncomingForm.prototype.writeHeaders=function(headers){this.headers=headers,this._parseContentLength(),this._parseContentType()},IncomingForm.prototype.write=function(buffer){if(!this.error){if(!this._parser)return void this._error(new Error("uninitialized parser"));this.bytesReceived+=buffer.length,this.emit("progress",this.bytesReceived,this.bytesExpected);var bytesParsed=this._parser.write(buffer);return bytesParsed!==buffer.length&&this._error(new Error("parser error, "+bytesParsed+" of "+buffer.length+" bytes parsed")),bytesParsed}},IncomingForm.prototype.pause=function(){return!1},IncomingForm.prototype.resume=function(){return!1},IncomingForm.prototype.onPart=function(part){this.handlePart(part)},IncomingForm.prototype.handlePart=function(part){var self=this;if(void 0===part.filename){var value="",decoder=new StringDecoder(this.encoding);return part.on("data",function(buffer){return self._fieldsSize+=buffer.length,self._fieldsSize>self.maxFieldsSize?void self._error(new Error("maxFieldsSize exceeded, received "+self._fieldsSize+" bytes of field data")):void(value+=decoder.write(buffer))}),void part.on("end",function(){self.emit("field",part.name,value)})}this._flushing++;var file=new File({path:this._uploadPath(part.filename),name:part.filename,type:part.mime,hash:self.hash});this.emit("fileBegin",part.name,file),file.open(),this.openedFiles.push(file),part.on("data",function(buffer){0!=buffer.length&&(self.pause(),file.write(buffer,function(){self.resume()}))}),part.on("end",function(){file.end(function(){self._flushing--,self.emit("file",part.name,file),self._maybeEnd()})})},IncomingForm.prototype._parseContentType=function(){if(0===this.bytesExpected)return void(this._parser=dummyParser(this));if(!this.headers["content-type"])return void this._error(new Error("bad content-type header, no content-type"));if(this.headers["content-type"].match(/octet-stream/i))return void this._initOctetStream();if(this.headers["content-type"].match(/urlencoded/i))return void this._initUrlencoded();if(this.headers["content-type"].match(/multipart/i)){var m=this.headers["content-type"].match(/boundary=(?:"([^"]+)"|([^;]+))/i);return void(m?this._initMultipart(m[1]||m[2]):this._error(new Error("bad content-type header, no multipart boundary")))}return this.headers["content-type"].match(/json/i)?void this._initJSONencoded():void this._error(new Error("bad content-type header, unknown content-type: "+this.headers["content-type"]))},IncomingForm.prototype._error=function(err){this.error||this.ended||(this.error=err,this.emit("error",err),Array.isArray(this.openedFiles)&&this.openedFiles.forEach(function(file){file._writeStream.destroy(),setTimeout(fs.unlink,0,file.path,function(error){})}))},IncomingForm.prototype._parseContentLength=function(){this.bytesReceived=0,this.headers["content-length"]?this.bytesExpected=parseInt(this.headers["content-length"],10):void 0===this.headers["transfer-encoding"]&&(this.bytesExpected=0),null!==this.bytesExpected&&this.emit("progress",this.bytesReceived,this.bytesExpected)},IncomingForm.prototype._newParser=function(){return new MultipartParser},IncomingForm.prototype._initMultipart=function(boundary){this.type="multipart";var headerField,headerValue,part,parser=new MultipartParser,self=this;parser.initWithBoundary(boundary),parser.onPartBegin=function(){part=new Stream,part.readable=!0,part.headers={},part.name=null,part.filename=null,part.mime=null,part.transferEncoding="binary",part.transferBuffer="",headerField="",headerValue=""},parser.onHeaderField=function(b,start,end){headerField+=b.toString(self.encoding,start,end)},parser.onHeaderValue=function(b,start,end){headerValue+=b.toString(self.encoding,start,end)},parser.onHeaderEnd=function(){headerField=headerField.toLowerCase(),part.headers[headerField]=headerValue;var m=headerValue.match(/\bname="([^"]+)"/i);"content-disposition"==headerField?(m&&(part.name=m[1]),part.filename=self._fileName(headerValue)):"content-type"==headerField?part.mime=headerValue:"content-transfer-encoding"==headerField&&(part.transferEncoding=headerValue.toLowerCase()),headerField="",headerValue=""},parser.onHeadersEnd=function(){switch(part.transferEncoding){case"binary":case"7bit":case"8bit":parser.onPartData=function(b,start,end){part.emit("data",b.slice(start,end))},parser.onPartEnd=function(){part.emit("end")};break;case"base64":parser.onPartData=function(b,start,end){part.transferBuffer+=b.slice(start,end).toString("ascii");var offset=4*parseInt(part.transferBuffer.length/4,10);part.emit("data",new Buffer(part.transferBuffer.substring(0,offset),"base64")),part.transferBuffer=part.transferBuffer.substring(offset)},parser.onPartEnd=function(){part.emit("data",new Buffer(part.transferBuffer,"base64")),part.emit("end")};break;default:return self._error(new Error("unknown transfer-encoding"))}self.onPart(part)},parser.onEnd=function(){self.ended=!0,self._maybeEnd()},this._parser=parser},IncomingForm.prototype._fileName=function(headerValue){var m=headerValue.match(/\bfilename="(.*?)"($|; )/i);if(m){var filename=m[1].substr(m[1].lastIndexOf("\\")+1);return filename=filename.replace(/%22/g,'"'),filename=filename.replace(/&#([\d]{4});/g,function(m,code){return String.fromCharCode(code)})}},IncomingForm.prototype._initUrlencoded=function(){this.type="urlencoded";var parser=new QuerystringParser(this.maxFields),self=this;parser.onField=function(key,val){self.emit("field",key,val)},parser.onEnd=function(){self.ended=!0,self._maybeEnd()},this._parser=parser},IncomingForm.prototype._initOctetStream=function(){this.type="octet-stream";var filename=this.headers["x-file-name"],mime=this.headers["content-type"],file=new File({path:this._uploadPath(filename),name:filename,type:mime});this.emit("fileBegin",filename,file),file.open(),this._flushing++;var self=this;self._parser=new OctetParser;var outstandingWrites=0;self._parser.on("data",function(buffer){self.pause(),outstandingWrites++,file.write(buffer,function(){outstandingWrites--,self.resume(),self.ended&&self._parser.emit("doneWritingFile")})}),self._parser.on("end",function(){self._flushing--,self.ended=!0;var done=function(){file.end(function(){self.emit("file","file",file),self._maybeEnd()})};0===outstandingWrites?done():self._parser.once("doneWritingFile",done)})},IncomingForm.prototype._initJSONencoded=function(){this.type="json";var parser=new JSONParser,self=this;this.bytesExpected&&parser.initWithLength(this.bytesExpected),parser.onField=function(key,val){self.emit("field",key,val)},parser.onEnd=function(){self.ended=!0,self._maybeEnd()},this._parser=parser},IncomingForm.prototype._uploadPath=function(filename){for(var name="upload_",buf=crypto.randomBytes(16),i=0;i<buf.length;++i)name+=("0"+buf[i].toString(16)).slice(-2);if(this.keepExtensions){var ext=path.extname(filename);ext=ext.replace(/(\.[a-z0-9]+).*/i,"$1"),name+=ext}return path.join(this.uploadDir,name)},IncomingForm.prototype._maybeEnd=function(){!this.ended||this._flushing||this.error||this.emit("end")};