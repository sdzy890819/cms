var formidable=require("formidable"),http=require("http"),fs=require("fs"),url=require("url"),path=require("path"),uploadfoldername="uploadfiles",uploadfolderpath=path.join(__dirname,uploadfoldername),server="localhost",port=8012;http.createServer(function(req,res){var reqMethod=req.method.toLowerCase();if("/upload"!==req.url||"post"!==reqMethod&&"options"!==reqMethod){var pathname=url.parse(req.url).pathname,filepath=path.join(__dirname,pathname);fs.readFile(filepath,function(err,file){if(err)return res.writeHead(404),console.log("response file error: "+filepath),void res.end("404 NOT FOUND...");".css"===filepath.slice(filepath.lastIndexOf(".")-filepath.length)?res.writeHead("200",{"Content-type":"text/css"}):res.writeHead("200"),console.log("response file success: "+filepath),res.end(file)})}else{if(res.setHeader("Access-Control-Allow-Origin","http://localhost:8011"),res.setHeader("Access-Control-Allow-Headers","X-Requested-With"),res.setHeader("Access-Control-Allow-Methods","PUT,POST,GET,DELETE,OPTIONS"),"options"===reqMethod)return console.log("options 请求时，返回 200"),res.writeHead(200,{"Content-type":"text/html"}),void res.end("options OK");console.log("定位到 /upload 路由");(new formidable.IncomingForm).parse(req,function(err,fields,files){if(err)return console.log("formidable, form.parse err");console.log("formidable, form.parse ok");var item,length=0;for(item in files)length++;if(0===length)return void console.log("files no data");for(item in files){var file=files[item],tempfilepath=file.path,type=file.type,filename=file.name,extname=filename.lastIndexOf(".")>=0?filename.slice(filename.lastIndexOf(".")-filename.length):"";""===extname&&type.indexOf("/")>=0&&(extname="."+type.split("/")[1]),filename=Math.random().toString().slice(2)+extname;var filenewpath=path.join(uploadfolderpath,filename);fs.rename(tempfilepath,filenewpath,function(err){var result="";err?(console.log("fs.rename err"),result="error|save error"):(console.log("fs.rename done"),result="http://"+server+":"+port+"/"+uploadfoldername+"/"+filename),res.writeHead(200,{"Content-type":"text/html"}),res.end(result)})}})}}).listen(port),console.log("server start at http://"+server+":"+port);